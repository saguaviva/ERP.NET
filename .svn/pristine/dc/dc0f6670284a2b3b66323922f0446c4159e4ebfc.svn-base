Imports CoreLab.MySql
Imports Office = Microsoft.Office.Interop
Imports Excel = Microsoft.Office.Interop.Excel

Public Class clsDisposicion
    Inherits clsADO

    Public detalleDisposicion As clsDetalleDisposicion

#Region "CAMPOS"

    Private mCODI As Integer
    Public Property CODI() As Integer
        Get
            If PA = -1 Then Exit Property
            Try
                mCODI = nzn(dvForm(pa).Row("CODI"), 0)
            Catch ex As Exception : End Try
            Return nzn(mCODI, 0)
        End Get
        Set(ByVal Value As Integer)
            If PA = -1 Then Exit Property
            If nzn(Value, 0) <> nzn(CODI, 0) Then
                mCODI = nzn(Value, 0)
                dvForm(pa).Row("CODI") = nzn(mCODI, 0) : GuardarDV()
            End If
        End Set
    End Property

    Private mCODICLIENT As String
    Public Property CODICLIENT() As String
        Get
            If PA = -1 Then Exit Property
            Try
                mCODICLIENT = nz(dvForm(pa).Row("CODICLIENT"), "")
            Catch ex As Exception : End Try
            Return nz(mCODICLIENT, "")
        End Get
        Set(ByVal Value As String)
            If PA = -1 Then Exit Property
            If nz(Value, "") <> nz(CODICLIENT, "") Then
                mCODICLIENT = nz(Value, "")
                dvForm(pa).Row("CODICLIENT") = nz(mCODICLIENT, "") : GuardarDV()
            End If
        End Set
    End Property

    Private mANY As String
    Public Property ANY() As String
        Get
            If PA = -1 Then Exit Property
            Try
                mANY = nz(dvForm(pa).Row("ANY"), "")
            Catch ex As Exception : End Try
            Return nz(mANY, "")
        End Get
        Set(ByVal Value As String)
            If PA = -1 Then Exit Property
            If nz(Value, "") <> nz(ANY, "") Then
                mANY = nz(Value, "")
                dvForm(pa).Row("ANY") = nz(mANY, "") : GuardarDV()
            End If
        End Set
    End Property

    Private mIDDISPOS As Integer
    Public Property IDDISPOS() As Integer
        Get
            If PA = -1 Then Exit Property
            Try
                mIDDISPOS = nzn(dvForm(pa).Row("IDDISPOS"), 0)
            Catch ex As Exception : End Try
            Return nzn(mIDDISPOS, 0)
        End Get
        Set(ByVal Value As Integer)
            If PA = -1 Then Exit Property
            If nzn(Value, 0) <> nzn(IDDISPOS, 0) Then
                mIDDISPOS = nzn(Value, 0)
                dvForm(pa).Row("IDDISPOS") = nzn(mIDDISPOS, 0) : GuardarDV()
            End If
        End Set
    End Property

    Private mFECHA As Date
    Public Property FECHA() As Date
        Get
            If PA = -1 Then Exit Property
            Try
                mFECHA = dvForm(pa).Row("FECHA")
            Catch ex As Exception : End Try
            Return mFECHA
        End Get
        Set(ByVal Value As Date)
            If PA = -1 Then Exit Property
            If Value <> FECHA Then
                mFECHA = Value
                dvForm(pa).Row("FECHA") = mFECHA : GuardarDV()
            End If
        End Set
    End Property

    Private mDRECEPCION As Date
    Public Property DRECEPCION() As Date
        Get
            If PA = -1 Then Exit Property
            Try
                mDRECEPCION = dvForm(pa).Row("DRECEPCION")
            Catch ex As Exception : End Try
            Return mDRECEPCION
        End Get
        Set(ByVal Value As Date)
            If PA = -1 Then Exit Property
            If Value <> DRECEPCION Then
                mDRECEPCION = Value
                dvForm(pa).Row("DRECEPCION") = mDRECEPCION : GuardarDV()
            End If
        End Set
    End Property


    'Este ACABADOR es que viene el tejido es decir el ACABADOR
    Private mACABADOR As Integer
    Public Property ACABADOR() As Integer
        Get
            If PA = -1 Then Exit Property
            Try
                mACABADOR = nzn(dvForm(pa).Row("ACABADOR"), 0)
            Catch ex As Exception : End Try
            Return nzn(mACABADOR, 0)
        End Get
        Set(ByVal Value As Integer)
            If PA = -1 Then Exit Property
            If esCodigoExistente(dtAcabadores, CCTallers, Value) Then
                If nzn(Value, 0) <> 0 Then
                    mACABADOR = nzn(Value, 0)
                    dvForm(pa).Row("NOMACABADOR") = OBN(Value, dtAcabadores, CNTallers)
                    dvForm(pa).Row("ACABADOR") = nzn(Value, 0) : guardarDV()
                End If
            Else
                dvForm(pa).Row("ACABADOR") = DBNull.Value

                dvForm(pa).Row("NOMACABADOR") = "" : guardarDV()
                MessageBox.Show(RM.GetString("NOEXISTETALLERS"))
            End If
        End Set
    End Property

    Private mNOMACABADOR As String
    Public Property NOMACABADOR() As String
        Get
            If PA = -1 Then Exit Property
            Try
                mNOMACABADOR = nz(dvForm(pa).Row("NOMACABADOR"), "")
            Catch ex As Exception : End Try
            Return nz(mNOMACABADOR, "")
        End Get
        Set(ByVal Value As String)
            If PA = -1 Then Exit Property
            mNOMACABADOR = nz(Value, "")
            If tabla.GetChanges Is Nothing Then
                dvForm(pa).Row("NOMACABADOR") = nz(Value, "") : guardarDV()
                tabla.AcceptChanges()
            Else
                dvForm(pa).Row("NOMACABADOR") = nz(Value, "") : guardarDV()
            End If
        End Set
    End Property

    Private mANULADA As Boolean
    Public Property ANULADA() As Boolean
        Get
            If PA = -1 Then Exit Property
            Try
                mANULADA = dvForm(pa).Row("ANULADA")
            Catch ex As Exception : End Try
            Return mANULADA
        End Get
        Set(ByVal Value As Boolean)
            If PA = -1 Then Exit Property
            If Value <> ANULADA Then
                mANULADA = Value
                dvForm(pa).Row("ANULADA") = mANULADA : guardarDV()
            End If
        End Set
    End Property

    Private mCLIENT As Integer
    Public Property CLIENT() As Integer
        Get
            If PA = -1 Then Exit Property
            Try
                mCLIENT = nzn(dvForm(pa).Row("CLIENT"), 0)
            Catch ex As Exception : End Try
            Return nzn(mCLIENT, 0)
        End Get
        Set(ByVal Value As Integer)
            If PA = -1 Then Exit Property
            If esCodigoExistente(dtClients, CCClients, Value) Then
                If nzn(Value, 0) <> 0 Then
                    mCLIENT = nzn(Value, 0)
                    dvForm(pa).Row("NOMCLIENT") = OBN(Value, dtClients, CNClients)
                    dvForm(pa).Row("CLIENT") = nzn(Value, 0) : guardarDV()
                End If
            Else
                dvForm(pa).Row("CLIENT") = 0

                dvForm(pa).Row("NOMCLIENT") = "" : guardarDV()
                MessageBox.Show(RM.GetString("NOEXISTECLIENTS"))
            End If
        End Set
    End Property

    Private mNOMCLIENT As String
    Public Property NOMCLIENT() As String
        Get
            If PA = -1 Then Exit Property
            Try
                mNOMCLIENT = nz(dvForm(pa).Row("NOMCLIENT"), "")
            Catch ex As Exception : End Try
            Return nz(mNOMCLIENT, "")
        End Get
        Set(ByVal Value As String)
            If PA = -1 Then Exit Property
            mNOMCLIENT = nz(Value, "")
            If tabla.GetChanges Is Nothing Then
                dvForm(pa).Row("NOMCLIENT") = nz(Value, "") : guardarDV()
                tabla.AcceptChanges()
            Else
                dvForm(pa).Row("NOMCLIENT") = nz(Value, "") : guardarDV()
            End If
        End Set
    End Property

    Private mOBSERV As String
    Public Property OBSERV() As String
        Get
            If PA = -1 Then Exit Property
            Try
                mOBSERV = nz(dvForm(pa).Row("OBSERV"), "")
            Catch ex As Exception : End Try
            Return nz(mOBSERV, "")
        End Get
        Set(ByVal Value As String)
            If PA = -1 Then Exit Property
            If nz(Value, "") <> nz(OBSERV, "") Then
                mOBSERV = nz(Value, "")
                dvForm(pa).Row("OBSERV") = nz(mOBSERV, "") : guardarDV()
            End If
        End Set
    End Property

    Private mCOLORCLIENTE As String
    Public Property COLORCLIENTE() As String
        Get
            If PA = -1 Then Exit Property
            Try
                mCOLORCLIENTE = nz(dvForm(pa).Row("COLORCLIENTE"), "")
            Catch ex As Exception : End Try
            Return nz(mCOLORCLIENTE, "")
        End Get
        Set(ByVal Value As String)
            If PA = -1 Then Exit Property
            If nz(Value, "") <> nz(COLORCLIENTE, "") Then
                mCOLORCLIENTE = nz(Value, "")
                dvForm(pa).Row("COLORCLIENTE") = nz(mCOLORCLIENTE, "") : guardarDV()
            End If
        End Set
    End Property

    Private mTOTALPIEZAS As Integer
    Public Property TOTALPIEZAS() As Integer
        Get
            If PA = -1 Then Exit Property
            Try
                mTOTALPIEZAS = nzn(dvForm(pa).Row("TOTALPIEZAS"), 0)
            Catch ex As Exception : End Try
            Return nzn(mTOTALPIEZAS, 0)
        End Get
        Set(ByVal Value As Integer)
            If PA = -1 Then Exit Property
            If nzn(Value, 0) <> nzn(TOTALPIEZAS, 0) Then
                mTOTALPIEZAS = nzn(Value, 0)
                dvForm(pa).Row("TOTALPIEZAS") = nzn(mTOTALPIEZAS, 0) : guardarDV()
            End If
        End Set
    End Property

    Private mTOTALKG As Double
    Public Property TOTALKG() As Double
        Get
            If PA = -1 Then Exit Property
            Try
                mTOTALKG = nzn(dvForm(pa).Row("TOTALKG"), 0)
            Catch ex As Exception : End Try
            Return nzn(mTOTALKG, 0)
        End Get
        Set(ByVal Value As Double)
            If PA = -1 Then Exit Property
            If nzn(Value, 0) <> nzn(TOTALKG, 0) Then
                mTOTALKG = nzn(Value, 0)
                dvForm(pa).Row("TOTALKG") = nzn(mTOTALKG, 0) : guardarDV()
            End If
        End Set
    End Property

    Private mCOLOR As String
    Public Property COLOR() As String
        Get
            If PA = -1 Then Exit Property
            Try
                mCOLOR = nz(dvForm(pa).Row("COLOR"), "")
            Catch ex As Exception : End Try
            Return nz(mCOLOR, "")
        End Get
        Set(ByVal Value As String)
            If PA = -1 Then Exit Property
            If nz(Value, "") <> nz(COLOR, "") Then
                mCOLOR = nz(Value, "")
                dvForm(pa).Row("COLOR") = nz(mCOLOR, "") : guardarDV()
            End If
        End Set
    End Property

    Private mRECIBIDO As Boolean
    Public Property RECIBIDO() As Boolean
        Get
            If PA = -1 Then Exit Property
            Try
                mRECIBIDO = dvForm(pa).Row("RECIBIDO")
            Catch ex As Exception : End Try
            Return mRECIBIDO
        End Get
        Set(ByVal Value As Boolean)
            If PA = -1 Then Exit Property
            If Value <> RECIBIDO Then
                mRECIBIDO = Value
                dvForm(pa).Row("RECIBIDO") = mRECIBIDO : guardarDV()
            End If
        End Set
    End Property

    Private mCOMANDA As String
    Public Property COMANDA() As String
        Get
            If PA = -1 Then Exit Property
            Try
                mCOMANDA = nz(dvForm(pa).Row("COMANDA"), "")
            Catch ex As Exception : End Try
            Return nz(mCOMANDA, "")
        End Get
        Set(ByVal Value As String)
            If PA = -1 Then Exit Property
            If nz(Value, "") <> nz(COMANDA, "") Then
                mCOMANDA = nz(Value, "")
                dvForm(pa).Row("COMANDA") = nz(mCOMANDA, "") : guardarDV()
            End If
        End Set
    End Property




#End Region

#Region "VARIABLES"

    Public dtTejedores As New DataTable
    Public dtAcabadores As New DataTable
    Public dtTejidos As New DataTable
    Private dvColores As DataView
    Friend dtClients As New DataTable("CLIENTS")

#End Region

    Public Sub New(ByVal tabla As DataTable, _
                    ByVal centro As String,   ByRef bindingcontext As BindingContext)

        MyBase.New(tabla, centro, BindingContext, "CODI")
        Dim sqlSel As String
        Try
            sqlSinWhere = "SELECT " & tablaDisposiciones & ".*, " & _
                    " filiales.DESCRI AS NOMCENTRO " & _
                    " FROM " & tablaDisposiciones & " " & _
                    " LEFT JOIN filiales ON (filiales.CODI = " & tablaDisposiciones & ".CENTRO) "

            sqlSel = sqlSinWhere & _
                        " WHERE " & tablaDisposiciones & ".CENTRO = """ & centro & """ ORDER BY any, IDDispos " & _
                        " LIMIT 1"

            cmdSel.CommandText = sqlSel
            da.SelectCommand = cmdSel
            da.Fill(tabla)
            dvForm.Sort = "any, IDDispos"


            CargaTabla(tablaClientes, CCClients, CNClients, dtClients, True)
            CargarTablas()
            IniciarDetalleDisposicion()
            CargaTablaAcabadores()
            CargaTablaTejedores()
            MoverActual()

        Catch ex As Exception
            LOG(ex.ToString) : Cargando = False : ccn()
        End Try
    End Sub

#Region "DESPLAZAMIENTO"

    Public Overloads Sub SiguienteReg()
        Try
            MyBase.SiguienteReg()
            MoverActual()
        Catch ex As Exception
            LOG(ex.ToString) : Cargando = False : ccn()
        End Try
    End Sub
    Public Overloads Sub AnteriorReg()
        Try
            MyBase.AnteriorReg()
            MoverActual()
        Catch ex As Exception
            LOG(ex.ToString) : Cargando = False : ccn()
        End Try
    End Sub
    Public Overloads Sub UltimoReg()
        Try
            MyBase.UltimoReg()
            MoverActual()
        Catch ex As Exception
            LOG(ex.ToString) : Cargando = False : ccn()
        End Try
    End Sub
    Public Overloads Sub PrimeroReg()
        Try
            MyBase.PrimeroReg()
            MoverActual()
        Catch ex As Exception
            LOG(ex.ToString) : Cargando = False : ccn()
        End Try
    End Sub
    Public Overloads Sub CambiarAReg(ByVal id As String, ByVal accion As Integer)
        Dim sql As String
        Try
            sql = ""

            MyBase.CambiarAReg(id, "", accion)
            MoverActual()
        Catch ex As Exception
            LOG(ex.ToString) : Cargando = False : ccn()
        End Try
    End Sub

#End Region

#Region "ORGANIZAR"

    Private Sub CargaTablaAcabadores()
        Dim cmdSelect As New MySqlCommand
        Dim daSelect As New MySqlDataAdapter
        Try
            cmdSelect.CommandText = "SELECT TEIXITS.ACABADOR AS CODI, " & _
                    " TALLERS.NOM  " & _
                    " FROM TEIXITS  " & _
                    " LEFT JOIN TALLERS ON  " & _
                    " (TALLERS.CODI = TEIXITS.ACABADOR)   " & _
                    " WHERE TEIXITS.ACABADOR <> 0 AND  " & _
                    " TEIXITS.ACABADOR IS NOT NULL GROUP BY ACABADOR"

            cmdSelect.Connection = cnn
            daSelect.SelectCommand = cmdSelect
            ACN()
            dtAcabadores.Rows.Clear()
            daSelect.Fill(dtAcabadores)
            dtAcabadores.Columns("NOM").Caption = rm.GetString("NOMBRE")
            dtAcabadores.Columns("CODI").Caption = rm.GetString("CODIGO")

            dtAcabadores.DefaultView.Sort = "CODI"

            If Not cnn.State = ConnectionState.Closed Then
                cnn.Close()
            End If
        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    Public Sub CargarTablas()

        Try
            'If COLOR <> "" Then
            Dim cmdSelect As New MySqlCommand
            Dim daSelect As New MySqlDataAdapter
            Dim dtTemp As New DataTable
            Dim i As Integer

            'Los talleres seleccionables


            cmdSelect.Connection = cnn

            'cmdSelect.CommandText = "SELECT " & _
            '    " TEIXITS.CODI, " & _
            '    " TEIXITS.DESCRI, " & _
            '    " TEIXITS.TEIXIDOR, " & _
            '    " TEIXITS.RENDIMENT, " & _
            '    " TEIXITS.GRAMA, " & _
            '    " TEIXITS.AMPLE " & _
            '    " FROM TEIXITS " & _
            '    " LEFT JOIN FILCOL ON (TEIXITS.CODI = FILCOL.FIL) " & _
            '    " WHERE " & _
            '    " FILCOL.COLOR = """ & COLOR & """ AND " & _
            '    " TEIXITS.TEIXIDOR <> 0 AND " & _
            '    " TEIXITS.TEIXIDOR IS NOT NULL"

            cmdSelect.CommandText = "SELECT " & _
                " TEIXITS.CODI, TEIXITS.DESCRI, " & _
                " TEIXITS.RENDIMENT, " & _
                " TEIXITS.GRAMA, " & _
                " TEIXITS.ACABAT, " & _
                " TEIXITS.AMPLE, " & _
                " TEIXITS.TEIXIDOR, " & _
                " TEIXITS.ACABADOR " & _
                " FROM TEIXITS "


            daSelect.SelectCommand = cmdSelect
            dtTejidos.Rows.Clear()
            daSelect.Fill(dtTejidos)
            dtTejidos.Columns("CODI").Caption = rm.GetString("CODIGO")
            dtTejidos.Columns("DESCRI").Caption = rm.GetString("DESCRIPCION")
            dtTejidos.Columns("TEIXIDOR").Caption = rm.GetString("TEJEDOR")
            dtTejidos.Columns("GRAMA").Caption = rm.GetString("GRAMAJE")
            dtTejidos.Columns("RENDIMENT").Caption = rm.GetString("RENDIMIENTO")
            dtTejidos.Columns("AMPLE").Caption = rm.GetString("ANCHO")
            dtTejidos.Columns("ACABAT").Caption = rm.GetString("ACABADO")
            dtTejidos.Columns("ACABADOR").Caption = rm.GetString("ACABADOR")

            CargarIdentificadores()

            dtTejidos.DefaultView.Sort = "CODI"

            'Else
                'dtTejidos.Rows.Clear()
                'dtTejedores.Rows.Clear()
            'End If
        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    Public Overrides Sub CargarIdentificadores()
        Try
            CargaTabla(tablaDisposiciones, "CODI", CCDisposiciones, dtIdentificadores, True)
            dtIdentificadores.Columns("CODI").Caption = rm.GetString("CODIGO")
            'dtIdentificadores.Columns(CCDisposiciones).Caption = rm.GetString("DESCRIPCION")
            dvIdentificadores.RowFilter = "CENTRO = '" & centro & "' "
            dvIdentificadores.Sort = CCDisposiciones

        Catch ex As Exception
            LOG(ex.ToString)
        End Try
    End Sub
    Private Sub CargaTablaTejedores()
        Dim cmdSelect As New MySqlCommand
        Dim daSelect As New MySqlDataAdapter
        Try
            'cmdSelect.CommandText = "SELECT DISTINCT TEIXITS.TEIXIDOR AS CODI, " & _
            '      " TALLERS.NOM " & _
            '      " FROM TEIXITS " & _
            '      " LEFT JOIN TALLERS ON (TALLERS.CODI = TEIXITS.TEIXIDOR) " & _
            '      " LEFT JOIN FILCOL ON (TEIXITS.CODI = FILCOL.FIL) " & _
            '      " WHERE FILCOL.COLOR = """ & COLOR & """ AND " & _
            '      " TEIXITS.TEIXIDOR <> 0 AND " & _
            '      " TEIXITS.TEIXIDOR IS NOT NULL"
            cmdSelect.CommandText = "SELECT DISTINCT TEIXITS.TEIXIDOR AS CODI, " & _
                  " TALLERS.NOM " & _
                  " FROM TEIXITS " & _
                  " LEFT JOIN TALLERS ON (TALLERS.CODI = TEIXITS.TEIXIDOR) " & _
                  " WHERE " & _
                  " TEIXITS.TEIXIDOR <> 0 AND " & _
                  " TEIXITS.TEIXIDOR IS NOT NULL"

            cmdSelect.Connection = cnn
            daSelect.SelectCommand = cmdSelect

            dtTejedores.Rows.Clear()
            daSelect.Fill(dtTejedores)
            dtTejedores.DefaultView.Sort = "CODI"


        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    '// -----------------------------------------------------------------------------
    '// <summary>
    '// 
    '// </summary>
    '// <remarks>
    '// </remarks>
    '// <history>
    '// 	[Sergio]	09/02/2006	Created
    '// </history>
    '// -----------------------------------------------------------------------------
    Private Sub CanviarDetalleDispos()
        Try
            If Not PA() = -1 Then
                detalleDisposicion.dvForm.RowFilter = "DISPOS = '" & CODI & "'"
                With detalleDisposicion.dvForm.Table

                    .Columns("TEJEDOR").DefaultValue = 0
                    .Columns("NOMTEJEDOR").DefaultValue = ""
                    .Columns("NAlbaran").DefaultValue = ""
                    .Columns("Tejido").DefaultValue = ""
                    .Columns("Compos").DefaultValue = ""
                    .Columns("NPiezas").DefaultValue = 0
                    .Columns("SERVIDO").DefaultValue = False
                    .Columns("DISPUESTO").DefaultValue = False
                    .Columns("LINEA").DefaultValue = 10000
                    .Columns("TotalPiezas").DefaultValue = 0
                    .Columns("TotalKG").DefaultValue = 0
                    .Columns("DISPOS").DefaultValue = CODI
                    .Columns("CENTRO").DefaultValue = centro

                End With
                detalleDisposicion.dispo = Me
            End If

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try

    End Sub
    Private Sub IniciarDetalleDisposicion()
        Try
            Dim dt As New aura2k3.ds11.ddisposDataTable
            detalleDisposicion = New clsDetalleDisposicion(dt, centro, bc)
            detalleDisposicion.dispo = Me

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub


    Private Function getUltimaDisposicion() As Object
        Try
            Dim selecttemp As New MySqlCommand
            Dim año As Integer

            selecttemp.Connection = cnn
            'CHAPUZA, que pasa si ANY es verdaderamente un char?
            selecttemp.CommandText = "SELECT MAX(IDDispos) from " & tabla.TableName & " WHERE ANY = (SELECT MAX(CONVERT(ANY, SIGNED)) FROM DISPOS)"
            ACN()
            getUltimaDisposicion = selecttemp.ExecuteScalar
            CCN()

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function
    'Ha de obtener el parámetro ultimo año de la tabla de parámetros ya que es O6 no 06.

    Private Function getUltimoAño() As Object
        Try
            Dim selecttemp As New MySqlCommand
            selecttemp.Connection = cnn
            selecttemp.CommandText = "SELECT MAX(any) FROM " & tabla.TableName & ""
            ACN()
            getUltimoAño = selecttemp.ExecuteScalar
            CCN()

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function
    Public Overrides Sub NuevoRegistro()
        Dim drNew As DataRow
        Try
            ActualizarOrigen()
            tabla.Clear()
            drNew = tabla.NewRow()
            If tabla.Columns("CODI").DataType.GetTypeCode(tabla.Columns("CODI").DataType) = TypeCode.String Then
                drNew.Item("CODI") = ""
            Else
                drNew.Item("CODI") = ObtenerNuevoID()
            End If

            'drNew.Item("IDDISPOS") = nzn(getUltimaDisposicion(), 100) + 1
            drNew.Item("IDDISPOS") = DLookUp("CODI", "NUMERACIONES", "TABLA = ""DISPOS "" ") + 1
            'drNew.Item("ANY") = getUltimoAño()
            drNew.Item("ANY") = DLookUp("DESCRI", "NUMERACIONES", "TABLA = ""DISPOS "" ")
            drNew.Item("FECHA") = Date.Now.ToShortDateString
            drNew.Item("TOTALKG") = 0.0
            drNew.Item("TOTALPIEZAS") = 0.0
            drNew.Item("DRECEPCION") = Date.Now.ToShortDateString
            drNew.Item("RECIBIDO") = False
            drNew.Item("ANULADA") = False
            drNew.Item("ACABADOR") = nzn(CargaParametro("acabadorpordefecto"), 0)
            drNew.Item("COLOR") = COLOR
            drNew.Item("OBSERV") = "*Anotar els METRES en l'Albarà d'entrega " & vbCrLf & "*Anotar el CODIG DEL TEIXIT en l'Albarà d'entrega i a l'etiqueta de la peça " & vbCrLf & "*Respectar l'AMPLE de la peça que es demana."
            drNew.Item("CENTRO") = centro
            tabla.Rows.Add(drNew)

            CopiarDetalleANuevaDisp(drNew.Item("CODI"))
            'Try : codigoActual = tabla.DefaultView(pa).Item(campoID) : Catch ex As Exception : End Try
            MoverActual()

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    Private Sub CopiarDetalleANuevaDisp(ByVal codigo As Integer)
        Dim dr As DataRow
        Dim i As Integer
        Try

            For i = 0 To detalleDisposicion.dvForm.Count - 1
                dr = detalleDisposicion.tabla.NewRow
                CopiarFila(detalleDisposicion.dvForm(i).Row, dr)
                dr("DISPOS") = codigo
                dr("DISPUESTO") = False
                dr("SERVIDO") = False
                detalleDisposicion.tabla.Rows.Add(dr)
            Next

        Catch ex As Exception
            LOG(ex.ToString)
        End Try
    End Sub
    Public Overrides Sub ActualizarOrigen(Optional ByVal nocerrar As Boolean = False, Optional ByVal hackDetalle As Boolean = False)
        Try
            MyBase.ActualizarOrigen(True)
            detalleDisposicion.ActualizarOrigen(True, True)
            CCN()
        Catch ex As Exception
            Throw ex
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    Public Overrides Sub borrar()
        Try
            MyBase.borrar()
            detalleDisposicion.BorrarActualDVDetalle()
            MoverActual()

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    Private Sub MoverActual()
        Try
            ACN()
            CanviarDetalleDispos()
            'CargarTablas()
            PonerNombres()
            CCN()

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub


#End Region

#Region "OVERRIDES"

    Friend Overrides Function TieneCambios() As Boolean
        Try
            guardarDV()
            If Not tabla.GetChanges Is Nothing OrElse detalleDisposicion.TieneCambios Then
                Return True
            Else
                Return False
            End If

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function
    Friend Overrides Sub PonerNombres()
        Dim aceptarCambiosAlFinal As Boolean = False
        Try
            If tabla.GetChanges Is Nothing Then aceptarCambiosAlFinal = True
            NOMCLIENT = OBN(CLIENT, dtClients)
            NOMACABADOR = OBN(ACABADOR, dtAcabadores)

            If aceptarCambiosAlFinal AndAlso (Not tabla.GetChanges Is Nothing) Then tabla.AcceptChanges()

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False
        End Try
    End Sub
    Friend Overrides Function genWhere() As String
        Try
            Dim ret As String

            ret = "WHERE " & tabla.TableName & ".CENTRO = """ & centro & """"

            Return ret
        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function
    Friend Overrides Function GenOrder() As String
        Try
            Return ""
            'Return " ORDER BY TEMPORADA, CLIENT, SERIE, CODI "
        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function
    Friend Overrides Function ObtenerNumeroRegistro(ByVal id As Object) As Integer
        If id Is Nothing Then
            id = CODI
        End If

        Dim cmd As New MySqlCommand(" SELECT " & _
          " (SELECT COUNT(*) " & _
          " FROM " & tabla.TableName & " AS M2 WHERE " & _
          " M2.CODI < M1.CODI AND  " & WCNoTabla() & " ) AS rownum FROM " & tabla.TableName & " AS M1  WHERE CODI = """ & id & """ AND " & WCNoTabla() & GenOrder(), cnn)
        Try
            Dim idx As Object = cmd.ExecuteScalar()

            If idx Is Nothing Then Return -1
            Return idx '- 1

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function
    Friend Overrides Function genWhereNumeroRegistros() As String
        Try
            Return genWhere()
        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function

#End Region

#Region "IMPRIMIR"

    Private Sub PonerAcabador(ByVal objhoja As Excel.Worksheet)
        Dim cmdSel As New MySqlCommand
        Dim str As String
        Dim dareader As MySqlDataReader
        Try

            str = "SELECT NOM, DOM, CP, PROV, POB FROM " & tablaTalleres & " WHERE CODI = """ & ACABADOR & """ "

            cmdSel.CommandText = str
            cmdSel.Connection = cnn
            ACN()
            dareader = cmdSel.ExecuteReader

            While dareader.Read
                With dareader
                    objhoja.Range("G7:G10").Font.Bold = False
                    objhoja.Range("G7:G10").Font.Size = 12

                    objhoja.Range("G7:G7").Value = .Item("NOM")
                    objhoja.Range("G8:G8").Value = .Item("DOM")
                    objhoja.Range("G9:G9").Value = .Item("CP") & "-" & .Item("POB")
                    objhoja.Range("G10:G10").Value = .Item("PROV")
                End With
            End While
            dareader.Close()
            CCN()


        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    Private Function ObtenerHoja(ByVal celdas As Integer)
        Try

            Dim hojas As Integer
            Dim hoj As Integer
            hojas = Math.DivRem(celdas, 61, hoj)
            If hojas = 0 Then
                Return 1
            Else

                Return hojas + 1
            End If
        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function
    Private Function Cabe(ByVal fila As Integer, ByVal hoja As Integer) As Boolean
        Try

            'Dim tam As Integer = fila * hoja
            If fila > 61 * hoja Then
                Return False
            Else
                Return True
            End If

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function
    Private Function PonerTejido(ByVal objhoja As Excel.Worksheet, ByVal pos As Integer, ByVal hoja As Integer, ByVal j As Integer) As Integer
        Try

            Dim x As Integer = 6 + j * 8 + 61 * (hoja - 1)
            If hoja = 1 Then x = x + 10

            If Cabe(x + 5, hoja) Then

                With objhoja

                    .Range("A" & x, "E" & x + 5).Font.Name = "Arial Narrow"
                    .Range("A" & x, "E" & x + 5).Font.Size = 10
                    .Range("A" & x, "A" & x).Value = pos + 1 & "-"

                    .Range("H" & x, "H" & x).Value = "Nº: "
                    .Range("H" & x, "H" & x).HorizontalAlignment = Excel.XlHAlign.xlHAlignRight

                    .Range("I" & x, "I" & x).Font.Color = RGB(0, 128, 0)
                    .Range("I" & x, "I" & x).Value = detalleDisposicion.dvForm(pos).Item("NALBARAN")
                    .Range("I" & x, "I" & x).HorizontalAlignment = Excel.XlHAlign.xlHAlignLeft

                    .Range("B" & x, "B" & x).Value = "Albarà PROVEÏDOR:"
                    .Range("D" & x, "D" & x + 5).Font.Color = RGB(0, 128, 0)
                    .Range("D" & x, "D" & x).Value = detalleDisposicion.dvForm(pos).Item("NOMTEJEDOR")

                    .Range("B" & x + 1, "B" & x + 1).Value = "CODI TEIXIT:"
                    .Range("B" & x + 2, "B" & x + 2).Value = "TEIXIT:"
                    .Range("B" & x + 3, "B" & x + 3).Value = "COMPOSICIÓ:"
                    .Range("B" & x + 4, "B" & x + 4).Value = "PECES Nº:"
                    .Range("B" & x + 5, "B" & x + 5).Value = "TOTAL PECES:"
                    .Range("B" & x + 6, "B" & x + 6).Value = "TOTAL KGs:"

                    .Range("D" & x).HorizontalAlignment = Excel.XlHAlign.xlHAlignLeft
                    .Range("D" & x + 1).HorizontalAlignment = Excel.XlHAlign.xlHAlignLeft
                    .Range("D" & x + 2).HorizontalAlignment = Excel.XlHAlign.xlHAlignLeft
                    .Range("D" & x + 3).HorizontalAlignment = Excel.XlHAlign.xlHAlignLeft
                    .Range("D" & x + 4).HorizontalAlignment = Excel.XlHAlign.xlHAlignLeft
                    .Range("D" & x + 5).HorizontalAlignment = Excel.XlHAlign.xlHAlignLeft
                    .Range("D" & x + 6).HorizontalAlignment = Excel.XlHAlign.xlHAlignLeft

                    .Range("D" & x + 1, "D" & x + 1).Value = detalleDisposicion.dvForm(pos).Item("TEJIDO")
                    .Range("D" & x + 2, "D" & x + 2).Value = detalleDisposicion.dvForm(pos).Item("DESCRIPCIO")
                    .Range("D" & x + 3, "D" & x + 3).Value = detalleDisposicion.dvForm(pos).Item("COMPOS")
                    .Range("D" & x + 4, "D" & x + 4).Value = detalleDisposicion.dvForm(pos).Item("NPIEZAS")
                    .Range("D" & x + 5, "D" & x + 5).Value = detalleDisposicion.dvForm(pos).Item("TOTALPIEZAS")
                    .Range("D" & x + 6, "D" & x + 6).Value = detalleDisposicion.dvForm(pos).Item("TOTALKG")
                    .Range("E" & x + 6).Value = "Kgs."

                End With
                Return x + 5
            Else
                'Poner otra cabecera
                PonerCabecera(objhoja, hoja + 1)
                Return -1
            End If
        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function
    Private Function obteneriddispos() As String
        Dim s As String = ""
        Try
            If Not CODICLIENT = "" Then
                s = CODICLIENT & "-"
            End If
            s = s & IDDISPOS
            If Not ANY = "" Then
                s = s & "-" & ANY
            End If
            Return s
        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try

    End Function
    Public Sub InsertPicture(ByVal PictureFileName As String, ByVal TargetCell As Excel.Range, ByVal m_Excel As Object, _
                        ByVal CenterH As Boolean, ByVal CenterV As Boolean, Optional ByVal JustificarIzq As Boolean = False, _
                         Optional ByVal width As Integer = -1, Optional ByVal heigh As Integer = -1)
        ' inserts a picture at the top left position of TargetCell
        ' the picture can be centered horizontally and/or vertically
        Dim p As Object, t As Double, l As Double, w As Double, h As Double
        If TypeName(m_Excel.ActiveSheet) <> "Worksheet" Then Exit Sub
        If Dir(PictureFileName) = "" Then Exit Sub
        ' import picture
        p = m_Excel.ActiveSheet.Pictures.Insert(PictureFileName)

        ' determine positions
        With TargetCell
            t = .Top
            l = .Left
            If CenterH Then
                w = .Offset(0, 1).Left - .Left
                l = l + w / 2 - p.Width / 2
                If l < 1 Then l = 1
            End If
            If CenterV Then
                h = .Offset(1, 0).Top - .Top
                t = t + h / 2 - p.Height / 2
                If t < 1 Then t = 1
            End If
            If JustificarIzq Then
                w = .Offset(0, 1).Left - .Left
                l = l + w - p.Width
                If l < 1 Then l = 1
            End If
        End With
        ' position picture
        With p
            .Top = t
            .Left = l
            If heigh <> -1 Then
                .Width = heigh
                .Height = width
            End If
        End With
        p = Nothing
    End Sub
    Private Function PonerCabecera(ByVal objhoja As Excel.Worksheet, ByVal hoja As Integer) As Integer
        Dim i As Integer
        Dim mas As Integer = 62 * (hoja - 1) + 2
        Dim pathLogo As String
        If hoja = 1 Then
            mas = 13
        Else
        End If
        Try

            With objhoja.Range("A" & mas - 1 & ":I" & mas - 1).Borders(Excel.XlBordersIndex.xlEdgeTop)
                .LineStyle = Excel.XlLineStyle.xlContinuous
                .Weight = Excel.XlBorderWeight.xlThin
                '.ColorIndex = 3
            End With
            With objhoja.Range("A" & mas + 1 & ":I" & mas + 1).Borders(Excel.XlBordersIndex.xlEdgeBottom)
                .LineStyle = Excel.XlLineStyle.xlContinuous
                .Weight = Excel.XlBorderWeight.xlThin
                '.ColorIndex = 3
            End With
            If centro = "C" Then : pathLogo = directorio & "\imagenes\LOGO COESPUNT.tif"
            Else : pathLogo = directorio & "\imagenes\LOGO CYCO.tif" : End If
            InsertPicture(pathLogo, objhoja.Range(objhoja.Cells(1, 1), objhoja.Cells(1, 16)), objhoja.Application, False, False, False, 50, 70)
            With objhoja
                .Range("B" & mas & ":B" & mas).Font.Bold = True
                .Range("B" & mas & ":B" & mas).Font.Size = 12

                .Range("B" & mas & ":B" & mas).Value = "DISPOSICIO Nº:  "

                .Range("D" & mas & ":D" & mas).Font.Size = 12
                .Range("D" & mas & ":D" & mas).Font.Bold = True
                .Range("D" & mas & ":D" & mas).Font.Color = RGB(0, 128, 0)
                .Range("D" & mas & ":D" & mas).Value = obteneriddispos()

                .Range("H" & mas & ":H" & mas).Font.Color = RGB(0, 128, 0)


                .Range("G" & mas & ":G" & mas).Font.Size = 12
                .Range("G" & mas & ":G" & mas).Font.Bold = True
                .Range("G" & mas & ":G" & mas).Value = "DATA: "

                .Range("H" & mas & ":H" & mas).Font.Size = 12
                .Range("H" & mas & ":H" & mas).Font.Bold = True
                .Range("H" & mas & ":H" & mas).Font.Color = RGB(0, 128, 0)
                .Range("H" & mas & ":H" & mas).Value = FECHA.ToShortDateString
                '.Rows(mas - 1).RowHeight = 6
                '.Rows(mas + 1).RowHeight = 6

            End With
            Return mas + 2
        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function
    Private Sub PonerCabeceraCoespunt(ByVal xlsDir As ExcelDirecto.ExcelDirecto)
        Dim fuente As ExcelDirecto.ExcelDirecto.Fuente
        Try
            fuente.nombre = "Arial Narrow"
            fuente.tamaño = 8
            xlsDir.PonerFuenteARango("A5:A9", fuente)
            With xlsDir.objHojaExcel
                .Range("A5:A5").Value = "C/Masia de Can Coll.7 - Pol. Ind. Can Coll"
                .Range("A6:A6").Value = "08620 SANT VICENÇ DELS HORTS"
                .Range("A7:A7").Value = "Telf.: 93.337.07.79"
                .Range("A8:A8").Value = "Fax.: 93.337.35.74"
                .Range("A9:A9").Value = "N.I.F.B(-59352021)"
            End With


        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try

    End Sub
    Private Function PonerObservaciones(ByVal fila As Integer, ByVal xls As ExcelDirecto.ExcelDirecto) As Integer
        Try
            Dim hoja As Integer = ObtenerHoja(fila)
            Dim numeroTejidos As Integer = detalleDisposicion.dvForm.Count
            Dim i As Integer
            With xls.objHojaExcel

                If Cabe(fila + 8, hoja) Then

                    .Range("B" & fila + 1).Value = "OBSERVACIONS: "
                    Dim s() As String
                    s = OBSERV.Split(vbCrLf)
                    For i = 0 To s.Length - 1
                        If i = 0 Then
                            .Range("D" & fila + 1 + i).Value = s(i)
                        Else
                            .Range("D" & fila + 1 + i).Value = s(i).Substring(1, s(i).Length - 1)
                        End If
                    Next
                    fila = fila + i + 2
                    .Range("F" & fila).Font.Bold = True
                    .Range("F" & fila).Font.Size = 12
                    .Range("F" & fila).Font.Name = "Tahoma"
                    xls.PonerBordeARango(.Range("F" & fila, "I" & fila), Excel.XlBordersIndex.xlEdgeTop, Excel.XlLineStyle.xlContinuous, Excel.XlBorderWeight.xlThin, RGB(0, 0, 0))
                    .Range("F" & fila).Value = NOMCLIENT
                Else
                    fila = PonerCabecera(xls.objHojaExcel, hoja + 1)
                    PonerObservaciones(fila, xls)
                End If
            End With
            Return fila + 2

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function
    Private Function PonerOperaciones(ByVal fila As Integer, ByVal objHojaExcel As Excel.Worksheet) As Integer
        Try
            Dim hoja As Integer = ObtenerHoja(fila)
            Dim numeroTejidos As Integer = detalleDisposicion.dvForm.Count
            Dim i As Integer

            With objHojaExcel

                If Cabe(fila + numeroTejidos * 3 + 10, hoja) Then

                    .Range("B" & fila + 3).Value = "OPERACIONS"
                    .Range("B" & fila + 5).Value = "TINTAR A COLOR"
                    .Range("B" & fila + 6).Value = "COLORIT CLIENT"

                    .Range("E" & fila + 5).Font.Color = RGB(0, 128, 0)
                    .Range("E" & fila + 6).Font.Color = RGB(0, 128, 0)

                    .Range("E" & fila + 5).Value = COLOR
                    .Range("E" & fila + 6).Value = COLORCLIENTE

                    .Range("B" & fila + 9).Value = "OPERACIONS:"
                    .Range("B" & fila + 9 + numeroTejidos + 1).Value = "AMPLE PEÇA:"
                    .Range("B" & fila + 9 + numeroTejidos * 2 + 2).Value = "RENDIMENT:"
                    .Range("B" & fila + 9 + numeroTejidos * 3 + 3).Value = rm.GetString("GRAMAJE").ToUpper & ":"

                    fila = fila + 9

                    For i = 0 To numeroTejidos - 1

                        .Range("C" & fila + i).Font.Color = RGB(0, 128, 0)
                        .Range("E" & fila + i).Font.Color = RGB(0, 128, 0)

                        .Range("C" & fila, "C" & fila + numeroTejidos * 3 + 3 + i).Font.Color = RGB(0, 128, 0)
                        .Range("E" & fila, "E" & fila + numeroTejidos * 3 + 3 + i).Font.Color = RGB(0, 128, 0)
                        .Range("E" & fila, "E" & fila + numeroTejidos * 3 + 3 + i).HorizontalAlignment = Excel.XlHAlign.xlHAlignLeft

                        .Range("C" & fila + i).Value = detalleDisposicion.dvForm(i).Item("TEJIDO")
                        .Range("D" & fila + i).HorizontalAlignment = Excel.XlHAlign.xlHAlignRight
                        .Range("D" & fila + i).Value = i + 1 & "-"
                        .Range("E" & fila + i).Value = detalleDisposicion.dvForm(i).Item("ACABADO")

                        .Range("C" & fila + numeroTejidos + 1 + i).Value = detalleDisposicion.dvForm(i).Item("TEJIDO")
                        .Range("D" & fila + numeroTejidos + 1 + i).HorizontalAlignment = Excel.XlHAlign.xlHAlignRight
                        .Range("D" & fila + numeroTejidos + 1 + i).Value = i + 1 & "-"
                        .Range("E" & fila + numeroTejidos + 1 + i).Value = detalleDisposicion.dvForm(i).Item("ANCHO")

                        .Range("C" & fila + numeroTejidos * 2 + 2 + i).Value = detalleDisposicion.dvForm(i).Item("TEJIDO")
                        .Range("D" & fila + numeroTejidos * 2 + 2 + i).HorizontalAlignment = Excel.XlHAlign.xlHAlignRight
                        .Range("D" & fila + numeroTejidos * 2 + 2 + i).Value = i + 1 & "-"
                        .Range("E" & fila + numeroTejidos * 2 + 2 + i).Value = detalleDisposicion.dvForm(i).Item("RENDIMIENTO")

                        .Range("C" & fila + numeroTejidos * 3 + 3 + i).Value = detalleDisposicion.dvForm(i).Item("TEJIDO")
                        .Range("D" & fila + numeroTejidos * 3 + 3 + i).HorizontalAlignment = Excel.XlHAlign.xlHAlignRight
                        .Range("D" & fila + numeroTejidos * 3 + 3 + i).Value = i + 1 & "-"
                        .Range("E" & fila + numeroTejidos * 3 + 3 + i).Value = detalleDisposicion.dvForm(i).Item("GRAMAJE")

                    Next
                    fila = fila + numeroTejidos * 3 + 3 + i
                Else
                    fila = PonerCabecera(objHojaExcel, hoja + 1)
                    fila = PonerOperaciones(fila, objHojaExcel)
                End If

            End With

            Return fila

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function
    Private Function PonerTotal(ByVal fila As Integer, ByVal objHojaexcel As Excel.Worksheet) As Integer
        Try
            Dim hoja As Integer = ObtenerHoja(fila)
            Dim numeroTejidos As Integer = detalleDisposicion.dvForm.Count
            Dim i As Integer
            With objHojaexcel

                If Cabe(fila + 5, hoja) Then

                    With .Range("A" & fila + 3 & ":I" & fila + 3).Borders(Excel.XlBordersIndex.xlEdgeTop)
                        .LineStyle = Excel.XlLineStyle.xlContinuous
                        .Weight = Excel.XlBorderWeight.xlThin
                        '.ColorIndex = 3
                    End With
                    With .Range("A" & fila + 4 & ":I" & fila + 4).Borders(Excel.XlBordersIndex.xlEdgeBottom)
                        .LineStyle = Excel.XlLineStyle.xlContinuous
                        .Weight = Excel.XlBorderWeight.xlThin
                        '.ColorIndex = 3
                    End With

                    objHojaexcel.Range("B" & fila & ":B" & fila + 5).Font.Size = 10
                    objHojaexcel.Range("B" & fila & ":B" & fila + 5).Font.Name = "Arial Narrow"

                    objHojaexcel.Range("B" & fila + 3).Value = "Total Peces"
                    objHojaexcel.Range("B" & fila + 4).Value = "Total Kgs."

                    'objHojaexcel.Range("D" & fila + 3).Font.Color = RGB(0, 128, 0)
                    'objHojaexcel.Range("D" & fila + 4).Font.Color = RGB(0, 128, 0)

                    objHojaexcel.Range("D" & fila + 3, "D" & fila + 3).Font.Size = 11
                    objHojaexcel.Range("D" & fila + 3).Value = TOTALPIEZAS
                    objHojaexcel.Range("D" & fila + 4).Value = TOTALKG

                    objHojaexcel.Range("E" & fila + 4).Value = "Kgs."

                Else

                    fila = PonerCabecera(objHojaexcel, hoja + 1)
                    PonerTotal(fila, objHojaexcel)

                End If
            End With

            Return fila + 3

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function
    Public Sub ImprimirDisposicionActual()
        Dim xlsDir As New ExcelDirecto.ExcelDirecto(False, 62, 0, 0, 0, 0, True)
        Dim margenes As ExcelDirecto.ExcelDirecto.TamMargenes
        Dim i As Integer
        Dim hoja As Integer = 1
        Dim fila As Integer
        Dim temp As Integer
        Try

            xlsDir.AñadirHoja("Disposició", "Arial Narrow", True)
            With margenes
                .margen_der = 0.4
                .margen_inf = 0.4
                .margen_izq = 0.4
                .margen_sup = 0.4
            End With
            xlsDir.ConfigurarPagina(xlsDir.Orientacion.Vertical, margenes)
            xlsDir.m_Excel.Visible = True
            With xlsDir.objHojaExcel

                .Columns("A").ColumnWidth = "5,77"
                .Columns("C").ColumnWidth = "10"
                .Columns("D").ColumnWidth = "6,6"
                .Columns("F").ColumnWidth = "14"
                .Columns("G").ColumnWidth = "6,8"
                .Columns("H").ColumnWidth = "13"
                PonerCabeceraCoespunt(xlsDir)
                PonerAcabador(xlsDir.objHojaExcel)
                PonerCabecera(xlsDir.objHojaExcel, 1)

                Dim j As Integer
                For i = 0 To detalleDisposicion.dvForm.Count - 1
                    temp = PonerTejido(xlsDir.objHojaExcel, i, hoja, j)
                    If temp = -1 Then
                        'Una hoja nueva
                        j = 0
                        i = i - 1
                        hoja = hoja + 1
                    Else
                        j = j + 1
                    End If

                Next
                fila = temp

                fila = PonerTotal(fila, xlsDir.objHojaExcel)
                fila = PonerOperaciones(fila, xlsDir.objHojaExcel)
                fila = PonerObservaciones(fila, xlsDir)

                'PonerDatosCliente()

                xlsDir.LiberarExcel()

            End With

        Catch ex As Exception
            xlsDir.LiberarExcel()
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub

#End Region

    Public Function hayAlgunaSinDisponer() As Boolean
        Try
            Dim i As Integer
            For i = 0 To detalleDisposicion.dvForm.Count - 1
                If detalleDisposicion.dvForm(i).Item("DISPUESTO") = False Then
                    Return True
                End If
            Next
            Return False

        Catch ex As Exception
            LOG(ex.ToString)
        End Try
    End Function
    Private Function ComprobarActualizacion() As Double
        Dim numer As Double
        Try
            numer = DLookUp("CODI", "NUMERACIONES", "TABLA = ""DISPOS "" ") + 1
            If numer <> IDDISPOS Then Return numer

            Return IDDISPOS

        Catch ex As Exception
            LOG(ex.ToString)
        End Try
    End Function
    Public Sub ActualizarNumDisp(ByVal iddispos As Double)
        Dim cmd As New MySqlCommand
        Try

            cmd.Connection = cnn
            cmd.CommandText = "UPDATE NUMERACIONES SET " & _
                " CODI = " & iddispos & " " & _
                " WHERE " & _
                " TABLA = ""DISPOS"" "
            ACN()
            cmd.ExecuteNonQuery()
            CCN()

        Catch ex As Exception
            LOG(ex.ToString) : CCN()
        End Try
    End Sub
    Public Sub actualizarNumeraciones()
        Try
            IDDISPOS = ComprobarActualizacion()
            ActualizarNumDisp(IDDISPOS)

        Catch ex As Exception
            LOG(ex.ToString)
        End Try
    End Sub

End Class