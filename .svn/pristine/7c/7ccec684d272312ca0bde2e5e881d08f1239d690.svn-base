Imports MySql.Data.MySqlClient : Imports clsFuncionesLOG : Imports clsFuncionesC1 : Imports clsFuncionesUtiles : Imports clsConstantes : Imports clsOtrasFunciones
Imports Microsoft.Office.Interop

Public Class frmPlantillaLista
    Inherits aura2k3.frmBase

#Region " Código generado por el Diseñador de Windows Forms "

    Public Sub New()
        MyBase.New()
        'El Diseñador de Windows Forms requiere esta llamada.
        InitializeComponent() : Dim tom As SMcMaster.TabOrderManager = New SMcMaster.TabOrderManager(Me) : tom.SetTabOrder(SMcMaster.TabOrderManager.TabScheme.AcrossFirst)

        'Agregar cualquier inicialización después de la llamada a InitializeComponent()

    End Sub

    'Form reemplaza a Dispose para limpiar la lista de componentes.
    Protected Overloads Overrides Sub Dispose(ByVal disposing As Boolean)
        If disposing Then
            If Not (components Is Nothing) Then
                components.Dispose()
            End If
        End If
        MyBase.Dispose(disposing)
    End Sub

    'Requerido por el Diseñador de Windows Forms
    Private components As System.ComponentModel.IContainer

    'NOTA: el Diseñador de Windows Forms requiere el siguiente procedimiento
    'Puede modificarse utilizando el Diseñador de Windows Forms. 
    'No lo modifique con el editor de código.
    Friend WithEvents dgEleccionCampos As System.Windows.Forms.DataGrid
    Friend WithEvents btnImprimir As C1.Win.C1Input.C1Button
    Friend WithEvents lstCampos As System.Windows.Forms.ListBox
    Friend WithEvents btnFormulario As C1.Win.C1Input.C1Button
    Friend WithEvents btnExportarExcel As C1.Win.C1Input.C1Button
    Friend WithEvents dg As C1.Win.C1TrueDBGrid.C1TrueDBGrid
    Friend WithEvents btnExportarPDF As C1.Win.C1Input.C1Button
    Friend WithEvents btnCerrar As C1.Win.C1Input.C1Button
    Friend WithEvents btnActualizarSeleccion As C1.Win.C1Input.C1Button
    Friend WithEvents imgList As System.Windows.Forms.ImageList
    Friend WithEvents btnExportarAccess As C1.Win.C1Input.C1Button
    Friend WithEvents btnRecargarListado As C1.Win.C1Input.C1Button
    Friend WithEvents btnCancelar As C1.Win.C1Input.C1Button
    Friend WithEvents lblInformacion As C1.Win.C1Input.C1Label
    <System.Diagnostics.DebuggerStepThrough()> Private Sub InitializeComponent()
        Me.components = New System.ComponentModel.Container()
        Dim resources As System.ComponentModel.ComponentResourceManager = New System.ComponentModel.ComponentResourceManager(GetType(frmPlantillaLista))
        Me.btnExportarExcel = New C1.Win.C1Input.C1Button()
        Me.dg = New C1.Win.C1TrueDBGrid.C1TrueDBGrid()
        Me.dgEleccionCampos = New System.Windows.Forms.DataGrid()
        Me.btnImprimir = New C1.Win.C1Input.C1Button()
        Me.imgList = New System.Windows.Forms.ImageList(Me.components)
        Me.lstCampos = New System.Windows.Forms.ListBox()
        Me.btnFormulario = New C1.Win.C1Input.C1Button()
        Me.btnExportarPDF = New C1.Win.C1Input.C1Button()
        Me.btnCerrar = New C1.Win.C1Input.C1Button()
        Me.btnActualizarSeleccion = New C1.Win.C1Input.C1Button()
        Me.btnExportarAccess = New C1.Win.C1Input.C1Button()
        Me.btnRecargarListado = New C1.Win.C1Input.C1Button()
        Me.lblInformacion = New C1.Win.C1Input.C1Label()
        Me.btnCancelar = New C1.Win.C1Input.C1Button()
        CType(Me.dg, System.ComponentModel.ISupportInitialize).BeginInit()
        CType(Me.dgEleccionCampos, System.ComponentModel.ISupportInitialize).BeginInit()
        CType(Me.lblInformacion, System.ComponentModel.ISupportInitialize).BeginInit()
        Me.SuspendLayout()
        '
        'sbtipo
        '
        Me.sbtipo.FlatStyle = System.Windows.Forms.FlatStyle.Flat
        Me.sbtipo.Location = New System.Drawing.Point(5, 120)
        Me.sbtipo.Text = ""
        '
        'btnRecargar
        '
        Me.btnRecargar.Location = New System.Drawing.Point(60, 76)
        Me.btnRecargar.Size = New System.Drawing.Size(88, 20)
        '
        'btnSiguiente
        '
        Me.btnSiguiente.Location = New System.Drawing.Point(308, 96)
        '
        'btnAnterior
        '
        Me.btnAnterior.Location = New System.Drawing.Point(28, 96)
        '
        'btnPrimero
        '
        Me.btnPrimero.Location = New System.Drawing.Point(28, 76)
        '
        'btnUltimo
        '
        Me.btnUltimo.Location = New System.Drawing.Point(308, 76)
        '
        'btnModificar
        '
        Me.btnModificar.Location = New System.Drawing.Point(148, 96)
        Me.btnModificar.Size = New System.Drawing.Size(80, 20)
        '
        'btnTancar
        '
        Me.btnTancar.Location = New System.Drawing.Point(594, 96)
        '
        'btnBorrar
        '
        Me.btnBorrar.Location = New System.Drawing.Point(228, 96)
        Me.btnBorrar.Size = New System.Drawing.Size(80, 20)
        '
        'btnNuevo
        '
        Me.btnNuevo.Location = New System.Drawing.Point(148, 76)
        Me.btnNuevo.Size = New System.Drawing.Size(161, 20)
        '
        'btnActualizar
        '
        Me.btnActualizar.Location = New System.Drawing.Point(60, 96)
        Me.btnActualizar.Size = New System.Drawing.Size(88, 20)
        '
        'btnVerLista
        '
        Me.btnVerLista.Location = New System.Drawing.Point(594, 76)
        '
        'cboSeleccionCentro
        '
        Me.cboSeleccionCentro.Location = New System.Drawing.Point(280, 7)
        '
        'btnExportarExcel
        '
        Me.btnExportarExcel.Anchor = CType((System.Windows.Forms.AnchorStyles.Bottom Or System.Windows.Forms.AnchorStyles.Right), System.Windows.Forms.AnchorStyles)
        Me.btnExportarExcel.FlatStyle = System.Windows.Forms.FlatStyle.Flat
        Me.btnExportarExcel.ImageAlign = System.Drawing.ContentAlignment.MiddleLeft
        Me.btnExportarExcel.ImeMode = System.Windows.Forms.ImeMode.NoControl
        Me.btnExportarExcel.Location = New System.Drawing.Point(716, 501)
        Me.btnExportarExcel.Name = "btnExportarExcel"
        Me.btnExportarExcel.Size = New System.Drawing.Size(100, 23)
        Me.btnExportarExcel.TabIndex = 386
        Me.btnExportarExcel.Text = "Exportar a Excel"
        '
        'dg
        '
        Me.dg.AllowColSelect = False
        Me.dg.AllowUpdate = False
        Me.dg.AlternatingRows = True
        Me.dg.Anchor = CType((((System.Windows.Forms.AnchorStyles.Top Or System.Windows.Forms.AnchorStyles.Bottom) _
                    Or System.Windows.Forms.AnchorStyles.Left) _
                    Or System.Windows.Forms.AnchorStyles.Right), System.Windows.Forms.AnchorStyles)
        Me.dg.FilterBar = True
        Me.dg.FlatStyle = C1.Win.C1TrueDBGrid.FlatModeEnum.Standard
        Me.dg.Font = New System.Drawing.Font("Arial", 8.25!)
        Me.dg.GroupByCaption = "Drag a column header here to group by that column"
        Me.dg.Images.Add(CType(resources.GetObject("dg.Images"), System.Drawing.Image))
        Me.dg.Location = New System.Drawing.Point(8, 4)
        Me.dg.MarqueeStyle = C1.Win.C1TrueDBGrid.MarqueeEnum.HighlightRow
        Me.dg.Name = "dg"
        Me.dg.PreviewInfo.Location = New System.Drawing.Point(0, 0)
        Me.dg.PreviewInfo.Size = New System.Drawing.Size(0, 0)
        Me.dg.PreviewInfo.ZoomFactor = 75.0R
        Me.dg.PrintInfo.PageSettings = CType(resources.GetObject("dg.PrintInfo.PageSettings"), System.Drawing.Printing.PageSettings)
        Me.dg.Size = New System.Drawing.Size(902, 312)
        Me.dg.TabIndex = 385
        Me.dg.Text = "C1TrueDBGrid1"
        Me.dg.VisualStyle = C1.Win.C1TrueDBGrid.VisualStyle.Office2007Blue
        Me.dg.PropBag = resources.GetString("dg.PropBag")
        '
        'dgEleccionCampos
        '
        Me.dgEleccionCampos.Anchor = CType((System.Windows.Forms.AnchorStyles.Bottom Or System.Windows.Forms.AnchorStyles.Left), System.Windows.Forms.AnchorStyles)
        Me.dgEleccionCampos.DataMember = ""
        Me.dgEleccionCampos.HeaderForeColor = System.Drawing.SystemColors.ControlText
        Me.dgEleccionCampos.Location = New System.Drawing.Point(124, 321)
        Me.dgEleccionCampos.Name = "dgEleccionCampos"
        Me.dgEleccionCampos.Size = New System.Drawing.Size(292, 249)
        Me.dgEleccionCampos.TabIndex = 382
        '
        'btnImprimir
        '
        Me.btnImprimir.Anchor = CType((System.Windows.Forms.AnchorStyles.Bottom Or System.Windows.Forms.AnchorStyles.Right), System.Windows.Forms.AnchorStyles)
        Me.btnImprimir.BackColor = System.Drawing.SystemColors.Control
        Me.btnImprimir.FlatStyle = System.Windows.Forms.FlatStyle.Flat
        Me.btnImprimir.ImageAlign = System.Drawing.ContentAlignment.MiddleRight
        Me.btnImprimir.ImeMode = System.Windows.Forms.ImeMode.NoControl
        Me.btnImprimir.Location = New System.Drawing.Point(816, 524)
        Me.btnImprimir.Name = "btnImprimir"
        Me.btnImprimir.Size = New System.Drawing.Size(100, 22)
        Me.btnImprimir.TabIndex = 384
        Me.btnImprimir.Text = "Imprimir"
        Me.btnImprimir.TextAlign = System.Drawing.ContentAlignment.BottomCenter
        Me.btnImprimir.UseVisualStyleBackColor = False
        '
        'imgList
        '
        Me.imgList.ImageStream = CType(resources.GetObject("imgList.ImageStream"), System.Windows.Forms.ImageListStreamer)
        Me.imgList.TransparentColor = System.Drawing.Color.Transparent
        Me.imgList.Images.SetKeyName(0, "")
        '
        'lstCampos
        '
        Me.lstCampos.Anchor = CType((System.Windows.Forms.AnchorStyles.Bottom Or System.Windows.Forms.AnchorStyles.Left), System.Windows.Forms.AnchorStyles)
        Me.lstCampos.BorderStyle = System.Windows.Forms.BorderStyle.FixedSingle
        Me.lstCampos.Location = New System.Drawing.Point(12, 325)
        Me.lstCampos.Name = "lstCampos"
        Me.lstCampos.SelectionMode = System.Windows.Forms.SelectionMode.MultiSimple
        Me.lstCampos.Size = New System.Drawing.Size(104, 210)
        Me.lstCampos.TabIndex = 381
        '
        'btnFormulario
        '
        Me.btnFormulario.Anchor = CType((System.Windows.Forms.AnchorStyles.Bottom Or System.Windows.Forms.AnchorStyles.Right), System.Windows.Forms.AnchorStyles)
        Me.btnFormulario.FlatStyle = System.Windows.Forms.FlatStyle.Flat
        Me.btnFormulario.ImageAlign = System.Drawing.ContentAlignment.MiddleLeft
        Me.btnFormulario.ImeMode = System.Windows.Forms.ImeMode.NoControl
        Me.btnFormulario.Location = New System.Drawing.Point(816, 501)
        Me.btnFormulario.Name = "btnFormulario"
        Me.btnFormulario.Size = New System.Drawing.Size(100, 23)
        Me.btnFormulario.TabIndex = 383
        Me.btnFormulario.Text = "Veure Fitxes"
        '
        'btnExportarPDF
        '
        Me.btnExportarPDF.Anchor = CType((System.Windows.Forms.AnchorStyles.Bottom Or System.Windows.Forms.AnchorStyles.Right), System.Windows.Forms.AnchorStyles)
        Me.btnExportarPDF.FlatStyle = System.Windows.Forms.FlatStyle.Flat
        Me.btnExportarPDF.ImageAlign = System.Drawing.ContentAlignment.MiddleLeft
        Me.btnExportarPDF.ImeMode = System.Windows.Forms.ImeMode.NoControl
        Me.btnExportarPDF.Location = New System.Drawing.Point(716, 524)
        Me.btnExportarPDF.Name = "btnExportarPDF"
        Me.btnExportarPDF.Size = New System.Drawing.Size(100, 22)
        Me.btnExportarPDF.TabIndex = 387
        Me.btnExportarPDF.Text = "Exportar a PDF"
        '
        'btnCerrar
        '
        Me.btnCerrar.Anchor = CType((System.Windows.Forms.AnchorStyles.Bottom Or System.Windows.Forms.AnchorStyles.Right), System.Windows.Forms.AnchorStyles)
        Me.btnCerrar.FlatStyle = System.Windows.Forms.FlatStyle.Flat
        Me.btnCerrar.ImageAlign = System.Drawing.ContentAlignment.MiddleLeft
        Me.btnCerrar.ImeMode = System.Windows.Forms.ImeMode.NoControl
        Me.btnCerrar.Location = New System.Drawing.Point(816, 546)
        Me.btnCerrar.Name = "btnCerrar"
        Me.btnCerrar.Size = New System.Drawing.Size(100, 22)
        Me.btnCerrar.TabIndex = 388
        Me.btnCerrar.Text = "Tancar"
        '
        'btnActualizarSeleccion
        '
        Me.btnActualizarSeleccion.Anchor = CType((System.Windows.Forms.AnchorStyles.Bottom Or System.Windows.Forms.AnchorStyles.Left), System.Windows.Forms.AnchorStyles)
        Me.btnActualizarSeleccion.FlatStyle = System.Windows.Forms.FlatStyle.Flat
        Me.btnActualizarSeleccion.ImageAlign = System.Drawing.ContentAlignment.MiddleLeft
        Me.btnActualizarSeleccion.ImeMode = System.Windows.Forms.ImeMode.NoControl
        Me.btnActualizarSeleccion.Location = New System.Drawing.Point(420, 322)
        Me.btnActualizarSeleccion.Name = "btnActualizarSeleccion"
        Me.btnActualizarSeleccion.Size = New System.Drawing.Size(68, 57)
        Me.btnActualizarSeleccion.TabIndex = 389
        Me.btnActualizarSeleccion.Text = "Actualizar Selecció"
        '
        'btnExportarAccess
        '
        Me.btnExportarAccess.Anchor = CType((System.Windows.Forms.AnchorStyles.Bottom Or System.Windows.Forms.AnchorStyles.Right), System.Windows.Forms.AnchorStyles)
        Me.btnExportarAccess.FlatStyle = System.Windows.Forms.FlatStyle.Flat
        Me.btnExportarAccess.ImageAlign = System.Drawing.ContentAlignment.MiddleLeft
        Me.btnExportarAccess.ImeMode = System.Windows.Forms.ImeMode.NoControl
        Me.btnExportarAccess.Location = New System.Drawing.Point(716, 546)
        Me.btnExportarAccess.Name = "btnExportarAccess"
        Me.btnExportarAccess.Size = New System.Drawing.Size(100, 22)
        Me.btnExportarAccess.TabIndex = 390
        Me.btnExportarAccess.Text = "Exportar a Access"
        '
        'btnRecargarListado
        '
        Me.btnRecargarListado.Anchor = CType((System.Windows.Forms.AnchorStyles.Bottom Or System.Windows.Forms.AnchorStyles.Right), System.Windows.Forms.AnchorStyles)
        Me.btnRecargarListado.FlatStyle = System.Windows.Forms.FlatStyle.Flat
        Me.btnRecargarListado.ImageAlign = System.Drawing.ContentAlignment.MiddleLeft
        Me.btnRecargarListado.ImeMode = System.Windows.Forms.ImeMode.NoControl
        Me.btnRecargarListado.Location = New System.Drawing.Point(492, 322)
        Me.btnRecargarListado.Name = "btnRecargarListado"
        Me.btnRecargarListado.Size = New System.Drawing.Size(72, 56)
        Me.btnRecargarListado.TabIndex = 391
        Me.btnRecargarListado.Text = "Recarregar Llistat"
        Me.btnRecargarListado.TextAlign = System.Drawing.ContentAlignment.MiddleLeft
        '
        'lblInformacion
        '
        Me.lblInformacion.Anchor = CType((System.Windows.Forms.AnchorStyles.Bottom Or System.Windows.Forms.AnchorStyles.Right), System.Windows.Forms.AnchorStyles)
        Me.lblInformacion.ImeMode = System.Windows.Forms.ImeMode.NoControl
        Me.lblInformacion.Location = New System.Drawing.Point(572, 324)
        Me.lblInformacion.Name = "lblInformacion"
        Me.lblInformacion.Size = New System.Drawing.Size(320, 52)
        Me.lblInformacion.TabIndex = 392
        Me.lblInformacion.Tag = Nothing
        '
        'btnCancelar
        '
        Me.btnCancelar.Anchor = CType((System.Windows.Forms.AnchorStyles.Bottom Or System.Windows.Forms.AnchorStyles.Right), System.Windows.Forms.AnchorStyles)
        Me.btnCancelar.FlatStyle = System.Windows.Forms.FlatStyle.Flat
        Me.btnCancelar.ImageAlign = System.Drawing.ContentAlignment.MiddleLeft
        Me.btnCancelar.ImeMode = System.Windows.Forms.ImeMode.NoControl
        Me.btnCancelar.Location = New System.Drawing.Point(716, 544)
        Me.btnCancelar.Name = "btnCancelar"
        Me.btnCancelar.Size = New System.Drawing.Size(100, 22)
        Me.btnCancelar.TabIndex = 393
        Me.btnCancelar.Visible = False
        '
        'frmPlantillaLista
        '
        Me.AutoScaleBaseSize = New System.Drawing.Size(5, 13)
        Me.ClientSize = New System.Drawing.Size(922, 571)
        Me.Controls.Add(Me.btnCancelar)
        Me.Controls.Add(Me.lblInformacion)
        Me.Controls.Add(Me.btnRecargarListado)
        Me.Controls.Add(Me.btnExportarAccess)
        Me.Controls.Add(Me.btnActualizarSeleccion)
        Me.Controls.Add(Me.btnCerrar)
        Me.Controls.Add(Me.btnExportarPDF)
        Me.Controls.Add(Me.btnExportarExcel)
        Me.Controls.Add(Me.dg)
        Me.Controls.Add(Me.dgEleccionCampos)
        Me.Controls.Add(Me.btnImprimir)
        Me.Controls.Add(Me.lstCampos)
        Me.Controls.Add(Me.btnFormulario)
        Me.Cursor = System.Windows.Forms.Cursors.Default
        Me.Font = New System.Drawing.Font("Microsoft Sans Serif", 8.25!)
        Me.Name = "frmPlantillaLista"
        Me.Text = "frmPlantillaLista"
        Me.Controls.SetChildIndex(Me.cboSeleccionCentro, 0)
        Me.Controls.SetChildIndex(Me.btnFormulario, 0)
        Me.Controls.SetChildIndex(Me.lstCampos, 0)
        Me.Controls.SetChildIndex(Me.btnImprimir, 0)
        Me.Controls.SetChildIndex(Me.dgEleccionCampos, 0)
        Me.Controls.SetChildIndex(Me.dg, 0)
        Me.Controls.SetChildIndex(Me.btnExportarExcel, 0)
        Me.Controls.SetChildIndex(Me.btnExportarPDF, 0)
        Me.Controls.SetChildIndex(Me.btnCerrar, 0)
        Me.Controls.SetChildIndex(Me.btnActualizarSeleccion, 0)
        Me.Controls.SetChildIndex(Me.sbtipo, 0)
        Me.Controls.SetChildIndex(Me.btnActualizar, 0)
        Me.Controls.SetChildIndex(Me.btnNuevo, 0)
        Me.Controls.SetChildIndex(Me.btnBorrar, 0)
        Me.Controls.SetChildIndex(Me.btnTancar, 0)
        Me.Controls.SetChildIndex(Me.btnUltimo, 0)
        Me.Controls.SetChildIndex(Me.btnPrimero, 0)
        Me.Controls.SetChildIndex(Me.btnAnterior, 0)
        Me.Controls.SetChildIndex(Me.btnSiguiente, 0)
        Me.Controls.SetChildIndex(Me.btnRecargar, 0)
        Me.Controls.SetChildIndex(Me.btnVerLista, 0)
        Me.Controls.SetChildIndex(Me.btnModificar, 0)
        Me.Controls.SetChildIndex(Me.btnExportarAccess, 0)
        Me.Controls.SetChildIndex(Me.btnRecargarListado, 0)
        Me.Controls.SetChildIndex(Me.lblInformacion, 0)
        Me.Controls.SetChildIndex(Me.btnCancelar, 0)
        CType(Me.dg, System.ComponentModel.ISupportInitialize).EndInit()
        CType(Me.dgEleccionCampos, System.ComponentModel.ISupportInitialize).EndInit()
        CType(Me.lblInformacion, System.ComponentModel.ISupportInitialize).EndInit()
        Me.ResumeLayout(False)

    End Sub

#End Region

#Region "VARIABLES"

    Friend dv As New DataView
    Friend textoListado As String = "Llistat"
    Friend nombreConsulta As String = "listado"
    Friend ArrayCampos As New Hashtable
    Private da As New MySql.Data.MySqlClient.MySqlDataAdapter
    Private fuente As New Font("Arial", 8, FontStyle.Regular)
    Friend cmdSelect As New MySql.Data.MySqlClient.MySqlCommand
    Friend EsEleccionOListado As Short = esListado
    Friend dr As DataRow
    Private fcargando As frCargando
    Public centro As String = empresaPorDefecto

#End Region

#Region "OVERRIDES"

    Friend Overridable Sub dg_DoubleClick(ByVal sender As Object, ByVal e As System.EventArgs) Handles dg.DoubleClick
    End Sub
    Friend Overridable Sub btnFormulario_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnFormulario.Click
    End Sub
    Friend Overridable Sub HacerArraysCampoNombre()
    End Sub
    Friend Overridable Sub CrearComandos()
    End Sub

#End Region

    Protected Friend Sub guardarDV(ByVal tabla As String)
        Dim bmPublishers As BindingManagerBase
        Dim drvRow As DataRowView
        Try
            bmPublishers = Me.BindingContext(ds.Tables(tabla))
            If Not bmPublishers.Count = 0 Then
                'Get the binding manager base object
                'Get the data row view for the current row
                drvRow = CType(bmPublishers.Current, DataRowView)
                If drvRow.IsEdit Then drvRow.EndEdit()
            End If

        Catch ex As Exception
            Debug.WriteLine("guardarDV:-> " & ex.ToString)
        End Try
    End Sub
    Private Sub DejarSoloLista()
        Try
            dgEleccionCampos.Visible = False
            btnExportarAccess.Visible = False
            btnExportarExcel.Visible = False
            btnExportarPDF.Visible = False
            btnFormulario.Visible = False
            btnImprimir.Visible = False
            lstCampos.Visible = False
            btnActualizarSeleccion.Visible = False
            btnRecargarListado.Visible = False
            lblInformacion.Visible = False

            btnCancelar.Visible = True
            btnCerrar.Text = rm.GetString("ACEPTAR")
            btnCancelar.Text = rm.GetString("CANCELAR")
            Dim d As System.Drawing.Point = btnCancelar.Location
            btnCancelar.Location = btnCerrar.Location
            btnCerrar.Location = d

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False
        End Try
    End Sub
    Friend Sub IniciarListado()
        Dim fuente As New Font("Arial", 8, FontStyle.Regular)
        Dim i As Integer
        Try
            cargando = True

            dg.Font = fuente

            HacerArraysCampoNombre()
            CrearComandos()
            ACN()
            cmdSelect.Connection = cnn
            da.SelectCommand = cmdSelect
            ds = New aura2k3.ds11
            da.Fill(ds, tabla)
            CCN()
            rellenarlista(lstCampos, tabla, ArrayCampos)
            For i = 0 To lstCampos.Items.Count - 1
                lstCampos.SetSelected(i, True)
            Next
            'lstCampos.SetSelected(0, True)
            rellenarDGLista(lstCampos, dgEleccionCampos)
            CrearVista(dv, dgEleccionCampos, lstCampos, ArrayCampos, tabla)
            InicializarDg2(tabla, dg, lstCampos, ArrayCampos, dv, fuente, False)
            'dg.Columns(0).SortDirection = C1.Win.C1TrueDBGrid.SortDirEnum.Descending
            'Try : dv.Sort = lstCampos.Items(0) : Catch EX As Exception : End Try
            cargando = False

            TamañarDG()

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    Private Sub TamañarDG()
        Dim tam As Integer = 0
        Dim i As Integer
        Try
            If EsEleccionOListado = esEleccion Then
                DejarSoloLista()
                AutoSizeCC(dg)
                With DirectCast(dg, C1.Win.C1TrueDBGrid.C1TrueDBGrid)
                    For i = 0 To .Splits(0).DisplayColumns.Count - 1
                        .Splits(0).DisplayColumns(i).AutoSize()
                        If .Splits(0).DisplayColumns(i).Width < .Splits(0).DisplayColumns(i).MinWidth Then
                            .Splits(0).DisplayColumns(i).Width = .Splits(0).DisplayColumns(i).MinWidth
                        End If
                        If .Splits(0).DisplayColumns(i).DataColumn.NumberFormat <> "" Then
                            .Splits(0).DisplayColumns(i).Width = .Splits(0).DisplayColumns(i).Width + 10
                        End If
                        If .Splits(0).DisplayColumns(i).Visible = True Then
                            tam = tam + .Splits(0).DisplayColumns(i).Width
                        End If
                    Next
                End With

                Me.Width = tam + 75
                dg.Height = Me.Height - 75
            End If

        Catch ex As Exception
            LOG(ex.ToString)
        End Try
    End Sub
    Private Sub lstCampos_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lstCampos.SelectedIndexChanged
        Try
            If Not cargando Then
                InicializarDg2(tabla, dg, lstCampos, ArrayCampos, dv, fuente, False)
                rellenarDGLista(lstCampos, dgEleccionCampos)
            End If

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try

    End Sub
    Private Sub btnExportarExcel_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnExportarExcel.Click
        Try
            CrearExcel(dg, lstCampos, textoListado, ArrayCampos, False)

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    Private Sub btnImprimir_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnImprimir.Click
        Try
            CrearExcel(dg, lstCampos, textoListado, ArrayCampos, True)

            'CrearTablaAccessLista(ArrayCampos, tabla, lstCampos)
            'RellenarTablaAccess2(ArrayCampos, lstCampos, tabla, dg)
            'CargarConsulta(nombreConsulta, lstCampos, dg, textoListado, ArrayCampos)

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    Private Sub btnExportarPDF_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnExportarPDF.Click
        Dim sDBPath As String
        Dim NavArchivos As System.Windows.Forms.SaveFileDialog
        Try

            NavArchivos = New System.Windows.Forms.SaveFileDialog
            NavArchivos.Filter = "Arxius pdf (*.pdf) | *.pdf"
            NavArchivos.InitialDirectory = "c:\"
            NavArchivos.ShowDialog()
            sDBPath = NavArchivos.FileName
            dg.ExportToPDF(sDBPath)

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    Private Sub btnActualizarSeleccion_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnActualizarSeleccion.Click
        Try
            CrearVista(dv, dgEleccionCampos, lstCampos, ArrayCampos, tabla)

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    Private Sub btnCerrar_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnCerrar.Click
        Try
            If EsEleccionOListado = esEleccion Then
                dg_DoubleClick(Nothing, Nothing)
            Else
                Me.Close()
            End If


        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    Private Sub crear(ByVal sDBPath As String)
        Try
            Dim accessDir As New AccessDirecto(tabla)
            Dim cat As ADOX.Catalog = New ADOX.Catalog
            Try
                cat.Create("Provider=Microsoft.Jet.OLEDB.4.0;" & _
                            "Data Source=" & sDBPath & ";" & _
                            "Jet OLEDB:Engine Type=5")
            Catch ex As Exception

            End Try

            accessDir.CrearTablaAccessLista(ArrayCampos, tabla, lstCampos, sDBPath)
            accessDir.RellenarTablaAccess2(ArrayCampos, lstCampos, tabla, dg, sDBPath)
            cat = Nothing

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    Private Sub btnExportarAccess_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnExportarAccess.Click
        Dim sDBPath As String
        Dim NavArchivos As System.Windows.Forms.SaveFileDialog
        Try

            NavArchivos = New System.Windows.Forms.SaveFileDialog
            NavArchivos.Filter = "Arxius access (*.mdb) | *.mdb"
            NavArchivos.InitialDirectory = "c:\"
            NavArchivos.ShowDialog()
            sDBPath = NavArchivos.FileName
            If Not sDBPath = "" Then
                crear(sDBPath)
            End If

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    Friend Sub CargandoFormulario()
        Try
            fcargando = New frCargando
            fcargando.Show()
            fcargando.Refresh()
            fcargando.BringToFront()

        Catch ex As Exception
            LOG(ex.ToString) : CCN() : cnn.Close()
        End Try
    End Sub
    Friend Sub CrearExcel(ByVal dg As C1.Win.C1TrueDBGrid.C1TrueDBGrid, _
                                 ByVal lst As ListBox, _
                                 ByVal titulo As String, _
                                 ByVal arrayc As Hashtable, _
                                 ByVal vistaprevia As Boolean)
        CargandoFormulario()
        Dim m_Excel As Excel.Application
        Dim i, j, z As Integer
        '' Creamos un objeto WorkBook 
        Dim objLibroExcel As Excel.Workbook
        '' Creamos un objeto WorkSheet
        Dim objHojaExcel As Excel.Worksheet
        Try

            m_Excel = New Excel.Application
            m_Excel.Visible = False
            
            '' Creamos una instancia del Workbooks de excel
            '' Creamos una instancia de la primera hoja de trabajo de excel
            objLibroExcel = m_Excel.Workbooks.Add()
            objHojaExcel = objLibroExcel.Worksheets(1)
            m_Excel.Application.ScreenUpdating = False
            m_Excel.Calculation = Excel.XlCalculation.xlCalculationManual
            objHojaExcel.Name = titulo
            objHojaExcel.Visible = Excel.XlSheetVisibility.xlSheetVisible
            '' Hacemos esta hoja la visible en pantalla 
            '' (como seleccionamos la primera esto no es necesario
            '' si seleccionamos una diferente a la primera si lo
            '' necesitariamos).
            objHojaExcel.Activate()
            objHojaExcel.Range("A1:D1").Merge()
            objHojaExcel.Range("A1:D1").Value = titulo
            objHojaExcel.Range("A1:D1").Font.Bold = True
            objHojaExcel.Range("A1:D1").Font.Size = 15

            z = 0
            fcargando.ProgressBar1.Maximum = dg.Splits(0).Rows.Count
            For i = 0 To dg.Splits(0).DisplayColumns.Count - 1

                If dg.Splits(0).DisplayColumns(i).Visible = True Then
                    objHojaExcel.Cells(3, z + 1).Font.Bold = True
                    objHojaExcel.Cells(3, z + 1).Value = dg.Splits(0).DisplayColumns(i).DataColumn.Caption
                    z = z + 1
                End If
            Next

            For i = 0 To dg.Splits(0).Rows.Count - 1
                fcargando.lblstatus.Text = roundnum(100 * i / dg.Splits(0).Rows.Count, 0) & " % " & rm.GetString("COMPLETADO")
                fcargando.ProgressBar1.Step = i
                Application.DoEvents()
                z = 0
                For j = 0 To dg.Splits(0).DisplayColumns.Count - 1
                    If dg.Splits(0).DisplayColumns(j).Visible = True Then
                        objHojaExcel.Cells(i + 5, z + 1) = dg.Item(i, dg.Splits(0).DisplayColumns(j).Name)
                        z = z + 1
                    End If

                Next
            Next

            objHojaExcel.Cells.EntireColumn.AutoFit()
            '' Selecionado todo el rango especificado
            If vistaprevia Then
                objLibroExcel.PrintPreview()
            Else

            End If

            objHojaExcel = Nothing
            objLibroExcel = Nothing
            m_Excel.Calculation = Excel.XlCalculation.xlCalculationAutomatic
            m_Excel.Visible = True
            m_Excel.ScreenUpdating = True
            fcargando.Close()
            fcargando = Nothing
            ' xls1.Save("prueba1.xls")
            ' abrirExcel()
        Catch ex1 As Exception
            MessageBox.Show(ex1.ToString)
        End Try

    End Sub

#Region "LISTAS"

    Friend Function gettipo(ByVal campo As String, ByVal arraycampos As Hashtable) As String
        Try
            Dim keys As ICollection = arraycampos.Keys
            Dim e As IEnumerator = keys.GetEnumerator
            While e.MoveNext
                If arraycampos(e.Current)(0) = campo Then
                    Return arraycampos(e.Current)(2)
                End If
            End While
        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try

    End Function

    Friend Sub rellenarlista(ByRef lst As ListBox, ByVal tabla As String, ByVal ArrayCampos As Hashtable, Optional ByVal tieneOrden As Boolean = False)
        Dim i As Integer
        Dim str As String
        Try
            'Esta funcion rellena la lista de los campos que se pueden elegir
            lst.Items.Clear()
            For i = 0 To ArrayCampos.Count - 1
                lst.Items.Add("----------------------------1")
            Next

            If tieneOrden Then

                For i = 0 To ds.Tables(tabla).Columns.Count - 1
                    If ArrayCampos.ContainsKey(ds.Tables(tabla).Columns(i).ColumnName.ToUpper) Then
                        str = ArrayCampos(ds.Tables(tabla).Columns(i).ColumnName)(1)
                        lst.Items.Insert(ArrayCampos(ds.Tables(tabla).Columns(i).ColumnName)(3), str)
                    End If
                Next
            Else
                For i = 0 To ds.Tables(tabla).Columns.Count - 1
                    If ArrayCampos.ContainsKey(ds.Tables(tabla).Columns(i).ColumnName.ToUpper) Then
                        str = ArrayCampos(ds.Tables(tabla).Columns(i).ColumnName)(1)
                        lst.Items.Add(str)
                    End If
                Next
            End If

            For i = 0 To ArrayCampos.Count - 1
                lst.Items.Remove("----------------------------1")
            Next


        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    Friend Sub rellenarDGLista(ByVal lstCampos As ListBox, ByVal dgEleccionCampos As DataGrid)
        Dim ts As DataGridTableStyle = New DataGridTableStyle
        Dim dt As New DataTable("ELECCION")
        Dim col() As DataColumn
        Dim c1 As New DataColumn("Camp")
        Dim c2 As New DataColumn("De")
        Dim c3 As New DataColumn("A")
        Dim i As Integer
        Dim dr As DataRow
        Try
            ts.MappingName = "ELECCION"
            dt.Columns.Add(c1)
            dt.Columns.Add(c2)
            dt.Columns.Add(c3)
            For i = 0 To lstCampos.SelectedItems.Count - 1
                dr = dt.NewRow
                dr(0) = lstCampos.SelectedItems(i)
                dr(1) = ""
                dr(2) = ""
                dt.Rows.Add(dr)
                dr = Nothing
            Next

            Dim c11 As New misControles.DataGridEnableTextBoxColumn(0)
            Dim c22 As New misControles.DataGridEnableTextBoxColumn(1)
            Dim c33 As New misControles.DataGridEnableTextBoxColumn(2)
            c11.MappingName = "Camp"
            c22.MappingName = "De"
            c33.MappingName = "A"
            c11.HeaderText = "Camp"
            c22.HeaderText = "De"
            c33.HeaderText = "A"
            ts.GridColumnStyles.Add(c11)
            ts.GridColumnStyles.Add(c22)
            ts.GridColumnStyles.Add(c33)
            AddHandler c11.CheckCellEnabled, New misControles.DataGridEnableTextBoxColumn.EnableCellEventHandler(AddressOf SetEnableValues)
            dgEleccionCampos.TableStyles.Clear()
            dgEleccionCampos.TableStyles.Add(ts)
            dgEleccionCampos.SetDataBinding(dt, "")

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    Public Sub SetEnableValues(ByVal sender As Object, ByVal e As misControles.DataGridEnableEventArgs)
        e.EnableValue = False
    End Sub
    Friend Sub CrearVista(ByRef dv As DataView, ByVal dgEleccionCampos As DataGrid, ByVal lstCampos As ListBox, ByVal arraycampos As Hashtable, ByVal tabla As String)
        Dim i As Integer
        Dim strFiltro As String = ""
        Dim a1, a2 As String
        Try

            dv.Table = ds.Tables(tabla)
            For i = 0 To lstCampos.SelectedItems.Count - 1
                a1 = dgEleccionCampos(i, 1).ToString
                a2 = dgEleccionCampos(i, 2).ToString

                If Not (a1 = "" Or a2 = "") Then
                    If i = lstCampos.SelectedItems.Count - 1 Then
                        strFiltro = strFiltro & GetNombreCampo(lstCampos.SelectedItems(i), 0, arraycampos) & " >= '" & a1 & "' AND " & GetNombreCampo(lstCampos.SelectedItems(i), 0, arraycampos) & " <= '" & a2 & "'"
                    Else
                        strFiltro = strFiltro & GetNombreCampo(lstCampos.SelectedItems(i), 0, arraycampos) & " >= '" & a1 & "' AND " & GetNombreCampo(lstCampos.SelectedItems(i), 0, arraycampos) & " <= '" & a2 & "' AND "
                    End If

                End If

            Next
            If Not strFiltro = "" Then
                If strFiltro.EndsWith("AND ") Then
                    strFiltro = strFiltro.Remove(strFiltro.Length - 4, 4)
                End If
            End If
            dv.RowFilter = strFiltro
            dgEleccionCampos.Refresh()

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try

    End Sub

    Friend Function gettipodetostring(ByVal tipo As String) As String
        Select Case tipo
            Case "System.String" : Return "string"
            Case "System.Integer" : Return "integer"
            Case "System.Date" : Return "date"
            Case "System.Double" : Return "double"
            Case "System.Int32" : Return "integer"
            Case "System.Int16" : Return "integer"
            Case "System.DateTime" : Return "date"
            Case "System.Boolean" : Return "boolean"
            Case "System.Char" : Return "string"
            Case "System.Decimal" : Return "double"
            Case "System.Single" : Return "double"
        End Select
        MessageBox.Show("TIPO NO SOPORTADO")
    End Function

#End Region

#Region "LISTAS2"

    Private Sub OrdenarDG(ByVal dg As C1.Win.C1TrueDBGrid.C1TrueDBGrid, ByVal a As Hashtable)
        Dim i As Integer
        Dim a2 As New ArrayList
        Dim e As IEnumerator
        Dim dc As C1.Win.C1TrueDBGrid.C1DisplayColumn

        Try
            e = a.GetEnumerator
            While e.MoveNext

                dc = dg.Splits(0).DisplayColumns.Item(e.Current.Value(0))

                'Dim cosa(1) As Object
                'cosa(0) = e.Current.Value(3)
                'cosa(1) = e.Current.Value(0)
                'a2.Add(cosa)
                dg.Splits(0).DisplayColumns.RemoveAt(dg.Splits(0).DisplayColumns.IndexOf(dc))
                dg.Splits(0).DisplayColumns.Insert(e.Current.Value(3), dc)

            End While



            For i = 0 To a2.Count - 1

            Next

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    Friend Sub InicializarDg2(ByVal tabla As String, _
                ByRef dg As C1.Win.C1TrueDBGrid.C1TrueDBGrid, _
                ByVal lstCampos As ListBox, _
                ByVal arraycampos As Hashtable, _
                ByRef dv As DataView, _
                ByVal fuente As Font, _
                ByVal sololectura As Boolean, _
                Optional ByVal tieneOrden As Boolean = False)
        Dim i As Integer
        Dim nombrecampo As String
        Dim orden As Integer
        Try
            dg.SetDataBinding(dv, "")
            dg.Refresh()
            OcultarColumnasDG(dg)
            With dg.Splits(0).DisplayColumns
                For i = 0 To lstCampos.SelectedItems.Count - 1
                    nombrecampo = GetNombreCampo(lstCampos.Items(lstCampos.SelectedIndices(i)), 0, arraycampos)
                    orden = arraycampos(nombrecampo)(3)
                    If orden = 0 Then
                        Select Case arraycampos(nombrecampo)(2)
                            Case "date"
                                PPCol2(nombrecampo, dg, lstCampos.Items(lstCampos.SelectedIndices(i)), "Short Date", True, 1, True, C1.Win.C1TrueDBGrid.PresentationEnum.Normal, False, 1, -1, False)
                            Case "boolean"
                                PPCol2(nombrecampo, dg, lstCampos.Items(lstCampos.SelectedIndices(i)), "", True, 1, True, C1.Win.C1TrueDBGrid.PresentationEnum.CheckBox, False, 1, -1, False)
                            Case Else
                                PPCol2(nombrecampo, dg, lstCampos.Items(lstCampos.SelectedIndices(i)), "", True, 1, True, C1.Win.C1TrueDBGrid.PresentationEnum.Normal, False, 1, -1, False)
                        End Select
                        
                    Else
                        Select Case arraycampos(nombrecampo)(2)
                            Case "date"
                                PPCol2(nombrecampo, dg, lstCampos.Items(lstCampos.SelectedIndices(i)), "Short Date", True, 1, True, C1.Win.C1TrueDBGrid.PresentationEnum.Normal, False, 1, orden, False)
                            Case "boolean"
                                PPCol2(nombrecampo, dg, lstCampos.Items(lstCampos.SelectedIndices(i)), "", True, 1, True, C1.Win.C1TrueDBGrid.PresentationEnum.CheckBox, False, 1, orden, False)
                            Case Else
                                PPCol2(nombrecampo, dg, lstCampos.Items(lstCampos.SelectedIndices(i)), "", True, 1, True, C1.Win.C1TrueDBGrid.PresentationEnum.Normal, False, 1, orden, False)
                        End Select
                    End If
                Next
            End With
            dg.AllowAddNew = False
            dg.AllowDelete = False
            dg.AllowUpdate = False

            dg.Font = fuente
            If tabla = tablaDisposiciones Then : OrdenarDG(dg, arraycampos) : End If
            AutoSizeCC(dg)

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub

#End Region

    Friend Function GetNombreCampo(ByVal val As String, ByVal campodesc As Byte, ByVal arraycampos As Hashtable) As Object
        'El campodesc nos indica que tenemos q devolver si el nombre
        'del campo o la despcripcion
        Try
            Dim keys As ICollection = arraycampos.Keys
            Dim e As IEnumerator = keys.GetEnumerator
            While e.MoveNext
                ' MessageBox.Show("dfhnbwsfkjbgsn" & e.Current)
                If arraycampos(e.Current)(1) = val Then
                    Return arraycampos(e.Current)(campodesc)
                End If
            End While
            'Return ArrayCampos.Item(lstCampos.Items(val))(0)
        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function
    Private Sub btnRecargarListado_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnRecargarListado.Click
        IniciarListado()
    End Sub
    Private Sub frmPlantillaLista_Closing(ByVal sender As Object, ByVal e As System.ComponentModel.CancelEventArgs) Handles MyBase.Closing
        'Me.MdiParent.childCerrado(Nothing, Nothing)
    End Sub
    Private Sub frmPlantillaLista_Load(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles MyBase.Load
        lblInformacion.Value = rm.GetString("ELEGIRFICHA")
    End Sub

End Class

