Imports CoreLab.MySql

Public Class clsTraspasosCompra
    Inherits clsADO

#Region "VARIABLES"

    Public PAF As clsPAFCompra
    Private Nuevodocumento as string

#End Region

#Region "CAMPOS"

    Private mFRA As Integer
    Public Property FRA() As Integer
        Get
            If PA = -1 Then Exit Property
            Try
                mFRA = nzn(dvForm(pa).Row("FRA"), 0)
            Catch ex As Exception : End Try
            Return nzn(mFRA, 0)
        End Get
        Set(ByVal Value As Integer)
            If PA = -1 Then Exit Property
            mFRA = nzn(Value, 0)
            dvForm(pa).Row("FRA") = nzn(Value, 0) : guardarDV()
        End Set
    End Property

    Private mTIPUS As String
    Public Property TIPUS() As String
        Get
            If PA = -1 Then Exit Property
            Try
                mTIPUS = nz(dvForm(pa).Row("TIPUS"), "")
            Catch ex As Exception : End Try
            Return nz(mTIPUS, "")
        End Get
        Set(ByVal Value As String)
            If PA = -1 Then Exit Property
            mTIPUS = nz(Value, "")
            dvForm(pa).Row("TIPUS") = nz(Value, "") : guardarDV()
        End Set
    End Property

    Private mDOCUMENT As String
    Public Property DOCUMENT() As String
        Get
            If PA = -1 Then Exit Property
            Try
                mDOCUMENT = nz(dvForm(pa).Row("DOCUMENT"), "")
            Catch ex As Exception : End Try
            Return nz(mDOCUMENT, "")
        End Get
        Set(ByVal Value As String)
            If PA = -1 Then Exit Property
            mDOCUMENT = nz(Value, "")
            dvForm(pa).Row("DOCUMENT") = nz(Value, "") : guardarDV()
        End Set
    End Property

    Private mDATA As Date
    Public Property DATA() As Date
        Get
            If PA = -1 Then Exit Property
            Try
                mDATA = dvForm(pa).Row("DATA")
            Catch ex As Exception : End Try
            Return mDATA
        End Get
        Set(ByVal Value As Date)
            If PA = -1 Then Exit Property
            mDATA = Value
            dvForm(pa).Row("DATA") = Value : guardarDV()
        End Set
    End Property

    Private mQUANTITAT As Double
    Public Property QUANTITAT() As Double
        Get
            If PA = -1 Then Exit Property
            Try
                mQUANTITAT = nzn(dvForm(pa).Row("QUANTITAT"), 0)
            Catch ex As Exception : End Try
            Return nzn(mQUANTITAT, 0)
        End Get
        Set(ByVal Value As Double)
            If PA = -1 Then Exit Property
            mQUANTITAT = nzn(Value, 0)
            dvForm(pa).Row("QUANTITAT") = nzn(Value, 0) : guardarDV()
        End Set
    End Property

    Private mNLINEA As Integer
    Public Property NLINEA() As Integer
        Get
            If PA = -1 Then Exit Property
            Try
                mNLINEA = nzn(dvForm(pa).Row("NLINEA"), 0)
            Catch ex As Exception : End Try
            Return nzn(mNLINEA, 0)
        End Get
        Set(ByVal Value As Integer)
            If PA = -1 Then Exit Property
            mNLINEA = nzn(Value, 0)
            dvForm(pa).Row("NLINEA") = nzn(Value, 0) : guardarDV()
        End Set
    End Property

    Private mALINEA As Integer
    Public Property ALINEA() As Integer
        Get
            If PA = -1 Then Exit Property
            Try
                mALINEA = nzn(dvForm(pa).Row("ALINEA"), 0)
            Catch ex As Exception : End Try
            Return nzn(mALINEA, 0)
        End Get
        Set(ByVal Value As Integer)
            If PA = -1 Then Exit Property
            mALINEA = nzn(Value, 0)
            dvForm(pa).Row("ALINEA") = nzn(Value, 0) : guardarDV()
        End Set
    End Property

    Private mTRASPASADA As Boolean
    Public Property TRASPASADA() As Boolean
        Get
            If PA = -1 Then Exit Property
            Try
                mTRASPASADA = dvForm(pa).Row("TRASPASADA")
            Catch ex As Exception : End Try
            Return mTRASPASADA
        End Get
        Set(ByVal Value As Boolean)
            If PA = -1 Then Exit Property
            mTRASPASADA = Value
            dvForm(pa).Row("TRASPASADA") = Value : guardarDV()
        End Set
    End Property

    Private mVC As String
    Public Property VC() As String
        Get
            If PA = -1 Then Exit Property
            Try
                mVC = nz(dvForm(pa).Row("VC"), "")
            Catch ex As Exception : End Try
            Return nz(mVC, "")
        End Get
        Set(ByVal Value As String)
            If PA = -1 Then Exit Property
            mVC = nz(Value, "")
            dvForm(pa).Row("VC") = nz(Value, "") : guardarDV()
        End Set
    End Property

    Private mCOMAN As Integer
    Public Property COMAN() As Integer
        Get
            If PA = -1 Then Exit Property
            Try
                mCOMAN = nzn(dvForm(pa).Row("COMAN"), 0)
            Catch ex As Exception : End Try
            Return nzn(mCOMAN, 0)
        End Get
        Set(ByVal Value As Integer)
            If PA = -1 Then Exit Property
            mCOMAN = nzn(Value, 0)
            dvForm(pa).Row("COMAN") = nzn(Value, 0) : guardarDV()
        End Set
    End Property

    Private mALBAR As Integer
    Public Property ALBAR() As Integer
        Get
            If PA = -1 Then Exit Property
            Try
                mALBAR = nzn(dvForm(pa).Row("ALBAR"), 0)
            Catch ex As Exception : End Try
            Return nzn(mALBAR, 0)
        End Get
        Set(ByVal Value As Integer)
            If PA = -1 Then Exit Property
            mALBAR = nzn(Value, 0)
            dvForm(pa).Row("ALBAR") = nzn(Value, 0) : guardarDV()
        End Set
    End Property

#End Region


    Public Sub New(ByVal tabla As DataTable, _
                   ByVal centro As String, ByRef bindingcontext As BindingContext, ByVal p As clsPAFCompra)

        MyBase.New(tabla, centro, bindingcontext, "ESDETALLE")
        Dim sqlSel As String
        Try
            PAF = p
            Me.centro = PAF.centro
            NuevoDocumento = ObtenerDocNuevo(p.DOCUMENT)
            sqlSinWhere = "SELECT dcfactutrasp.*, " & _
                            " filiales.DESCRI AS NOMCENTRO " & _
                            " FROM dcfactutrasp " & _
                            " LEFT JOIN filiales ON (filiales.CODI = dcfactutrasp.CENTRO) "

            Select Case PAF.DOCUMENT
                Case Pedido
                    sqlSel = sqlSinWhere & _
                                " WHERE dcfactutrasp.COMAN = """ & PAF.FRA & """ AND " & _
                                " dcfactutrasp.DOCUMENT = """ & NuevoDocumento & """ AND " & _
                                " dcfactutrasp.VC = ""C"" AND " & _
                                " dcfactutrasp.NLINEA = """ & PAF.lineasCompra.NLINEA & """ AND " & _
                                " dcfactutrasp.CENTRO = """ & PAF.centro & """ ORDER BY dcfactutrasp.FRA "
                Case Albaran
                    sqlSel = sqlSinWhere & _
                                " WHERE dcfactutrasp.ALBAR = """ & PAF.FRA & """ AND " & _
                                " dcfactutrasp.DOCUMENT = """ & NuevoDocumento & """ AND " & _
                                " dcfactutrasp.VC = ""C"" AND " & _
                                " dcfactutrasp.NLINEA = """ & PAF.lineasCompra.NLINEA & """ AND " & _
                                " dcfactutrasp.CENTRO = """ & PAF.centro & """ ORDER BY dcfactutrasp.FRA "
            End Select

            cmdSel.CommandText = sqlSel

            dvForm.Sort = "FRA"
            da.SelectCommand = cmdSel
            da.Fill(tabla)
            PonerDefaults()

            'CreaTablas()
            'PonerDefaults()
            'DespertarHandlers()

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    Private Sub PonerDefaults()
        Try
            '+------------+---------------------+------+-----+------------+-------+
            '| Field      | Type                | Null | Key | Default    | Extra |
            '+------------+---------------------+------+-----+------------+-------+
            '| FRA        | int(11)             | NO   |     | 0          |       |
            '| TIPUS      | char(1)             | NO   | PRI |            |       |
            '| DOCUMENT   | char(1)             | NO   | PRI |            |       |
            '| DATA       | date                | NO   |     | 0000-00-00 |       |
            '| QUANTITAT  | double(15,3)        | YES  |     | NULL       |       |
            '| NLINEA     | int(11)             | NO   | PRI | 0          |       |
            '| ALINEA     | int(11)             | NO   | PRI | 0          |       |
            '| TRASPASADA | tinyint(1) unsigned | YES  |     | NULL       |       |
            '| VC         | char(1)             | NO   | PRI |            |       |
            '| COMAN      | int(11)             | NO   | PRI | 0          |       |
            '| ALBAR      | int(11)             | NO   | PRI | 0          |       |
            '| CENTRO     | char(1)             | NO   | PRI | C          |       |
            '+------------+---------------------+------+-----+------------+-------+

            'Ponemos 0 todavía no se sabe a donde va a ir
            dvForm.Table.Columns("FRA").DefaultValue = 0
            dvForm.Table.Columns("DOCUMENT").DefaultValue = NuevoDocumento
            dvForm.Table.Columns("TIPUS").DefaultValue = PAF.lineasCompra.TIPUS
            dvForm.Table.Columns("QUANTITAT").DefaultValue = 0
            dvForm.Table.Columns("NLINEA").DefaultValue = PAF.lineasCompra.NLINEA
            dvForm.Table.Columns("DATA").DefaultValue = Date.Today.ToShortDateString
            dvForm.Table.Columns("ALINEA").DefaultValue = 0
            dvForm.Table.Columns("TRASPASADA").DefaultValue = False
            dvForm.Table.Columns("VC").DefaultValue = "C"
            Select Case PAF.DOCUMENT
                Case Pedido
                    dvForm.Table.Columns("COMAN").DefaultValue = PAF.lineasCompra.FRA
                Case Albaran
                    dvForm.Table.Columns("ALBAR").DefaultValue = PAF.lineasCompra.FRA
            End Select
            dvForm.Table.Columns("CENTRO").DefaultValue = PAF.centro

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub

    Private Function DocDestinoCorrecto(ByVal af As Integer, ByVal doc As String, ByVal tipo As String, ByVal CENTRO As String) As Short
        Dim cmd As New MySqlCommand
        Dim dar As MySqlDataReader
        Try
            cmd.Connection = cnn
            cmd.CommandText = "SELECT count(TRASPAS) as cantidad, TRASPAS " & _
                " FROM CACTUR WHERE DOCUMENT = """ & doc & """ AND  " & _
                " CENTRO = """ & CENTRO & """ AND  " & _
                " FRA = """ & af & """ GROUP BY FRA"

            cnn.Open()
            dar = cmd.ExecuteReader
            dar.Read()
            If dar("cantidad") = 0 Then
                'Hay que crearlo
                dar.Close()
                cnn.Close()
                Return 1
            End If
            If Not dar("TRASPAS") = True Then
                dar.Close()
                cnn.Close()
                Return 2
            Else
                MessageBox.Show("L'Albarà  " & af & " ja ha sigut trasapassat")
                dar.Close()
                cnn.Close()
                Return 0
            End If

            dar.Close()
            cnn.Close()

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
            dar.Close()
            cnn.Close()
        End Try
    End Function

#Region "TRASPASO"

    Private Sub HacerTraspasoLinea()
        Dim aAF As Integer
        Dim quehacersiponenumerodestino As Short
        Try
            If FRA = 0 Then
                FRA = CrearPAFCompra(DATA, PAF.FRA, PAF.TIPUS, PAF.DOCUMENT, PAF.dvForm, centro)
                'Ponemos el docuemnto al que ha sido traspasado
                ALINEA = TraspasarNLineas2(FRA, QUANTITAT, PAF.lineasCompra)  ', QUANTITAT, PAF.lineasCompra.COLOR, PAF.lineasCompra.DOCUMENT, PAF.lineasCompra.TIPUS, PAF.lineasCompra.dvForm, FRA, NLINEA, centro)
            Else
                'Hay que controlora que el albbarán de destino sea correcto
                quehacersiponenumerodestino = DocDestinoCorrecto(FRA, NuevoDocumento, TIPUS, centro)
                Select Case quehacersiponenumerodestino
                    Case 0
                        'No hacer nada mensaje de error mostrado anteriormente pq el doc no es valido
                    Case 1
                        FRA = CrearPAFCompra(DATA, PAF.FRA, PAF.TIPUS, PAF.DOCUMENT, PAF.dvForm, centro, FRA)
                        ALINEA = TraspasarNLineas2(FRA, QUANTITAT, PAF.lineasCompra)
                    Case 2
                        'Ya existe
                        ALINEA = TraspasarNLineas2(FRA, QUANTITAT, PAF.lineasCompra)
                End Select
            End If

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    ''' -----------------------------------------------------------------------------
    ''' <summary>
    '''TIPUS=M y DOCUMENT=A y introduciremos en DFACTU las lineas q tenemos
    '''en el dgActual
    '''Primero seleccionar 
    '''NO BORRAR
    '''Hay que buscar las lineas de AF de de aAF y mirar si tiene algun tejido
    '''q cumpla lo de color, tejido, documentonuevo y tipo
    '''Si existe le incrementamos la cantidad y recalculamos todos lo campos!! 
    '''Esto ultimo parece que el programa no lo hace actualmente preguntar
    '''End If
    '''Miramos el numero de lineas del AF y insertamos una nueva con lo que nos han pasado
    ''' </summary>
    ''' <param name="aAF"></param>
    ''' <param name="cantidad"></param>
    ''' <param name="linea"></param>
    ''' <returns></returns>
    ''' <remarks>
    ''' </remarks>
    ''' <history>
    ''' 	[Sergio]	28/04/2005	Created
    ''' </history>
    ''' -----------------------------------------------------------------------------
    Friend Function TraspasarNLineas2(ByVal aAF As Integer, ByVal cantidad As Double, ByVal linea As clsLineasCompra) ' ByVal tejido As String, ByVal cantidad As Integer, ByVal color As String, ByVal documento as string, ByVal tipo as string, ByVal dvLineas As DataView, ByVal dePA As Integer, ByVal nlinea As Integer, ByVal CENTRO As Char)
        Dim i As Integer
        Dim cmdInsertar As New MySqlCommand
        Dim documentonuevo As String = ObtenerDocNuevo(linea.DOCUMENT)
        Dim cmdSel As MySqlCommand
        Dim nlineas As Integer
        Try

            cmdSel = New MySqlCommand("SELECT COUNT(*) FROM " & tablaLineasCompras & " WHERE " & _
                    " (TIPUS = """ & linea.TIPUS & """ AND " & _
                    " DOCUMENT = """ & documentonuevo & """ AND " & _
                    " FRA = """ & aAF & """ AND " & _
                    " CENTRO = """ & linea.centro & """)", cnn)
            ACN()
            nlineas = cmdSel.ExecuteScalar + 1
            CCN()
            cmdInsertar.Connection = cnn
            'Solo hay una PAF a traspasar en este caso pq son las lineas
            'Obtenemos la linea a traspasar

            cmdInsertar.Connection = cnn
            cmdInsertar.CommandText = "INSERT INTO " & tablaLineasCompras & "( " & _
                    " TIPUS, " & _
                    " DOCUMENT,  " & _
                    " FRA,  " & _
                    " NLINEA,  " & _
                    " ARTICLE, " & _
                    " DESCRI,  " & _
                    " COLOR,  " & _
                    " TALLA,  " & _
                    " UNITATS,  " & _
                    " PREU,  " & _
                    " DTE,  " & _
                    " IMPORT,  " & _
                    " COMAN,  " & _
                    " ALBAR,  " & _
                    " FACTURA, " & _
                    " ESTOC,  " & _
                    " KM,  " & _
                    " PERREBRE,  " & _
                    " REBUT,  " & _
                    " CENTRO " & _
                    " ) VALUES (" & _
                    " """ & linea.TIPUS & """,  " & _
                    " """ & documentonuevo & """,  " & _
                    " " & aAF & ",  " & _
                    " " & nlineas & ", " & _
                    " """ & NS(linea.ARTICLE) & """,  " & _
                    " """ & NS(linea.DESCRI) & """,  " & _
                    " """ & NS(linea.COLOR) & """, " & _
                    " """ & NS(linea.TALLA) & """,  " & _
                    " """ & NS(cantidad, True) & """,  " & _
                    " """ & NS(linea.PREU, True) & """, " & _
                    " """ & NS(linea.DTE, True) & """,  " & _
                    " """ & NS(linea.IMPORT, True) & """, " & _
                    " " & linea.FRA & ",  " & _
                    " ""0"", " & _
                    " ""0"", " & _
                    " '', " & _
                    " """ & linea.KM & """, " & _
                    " """ & NS(linea.PERREBRE, True) & """, " & _
                    " """ & NS(linea.REBUT, True) & """, " & _
                    " """ & NS(linea.centro, True) & """)"

            'Ahora hay que insertarlo en dcfactutrasp
            ACN()
            cmdInsertar.ExecuteNonQuery()
            CCN()
            Return nlineas
        Catch ex As Exception
            LOG(ex.ToString) : CCN()
        End Try
    End Function

#End Region

#Region "CALCULOS"

    Public Sub CantidadTraspasada()
        Dim i As Integer
        Dim ret As Double = 0
        Try
            For i = 0 To dvForm.Count - 1
                If dvForm(i).Item("TRASPASADA") = True Then
                    ret = dvForm(i).Item("QUANTITAT") + ret
                End If
            Next

            PAF.lineasCompra.PERREBRE = PAF.lineasCompra.UNITATS - ret
            PAF.lineasCompra.REBUT = ret

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False
        End Try
    End Sub
    'En cantidad tenemos lo que tenemos que sumar de estoc. En paf.lineascompra.KG tenemos si son kilos o metros
    'El rendimiento del tejido se saca con el dlookup
    Private Function SumarQuitarDispuesto(ByVal MASMENOS As String, ByVal cantidad As Double)
        Dim METROS As Double
        Dim KILOS As Double
        Dim REND As Double
        Dim cmd As New MySqlCommand
        Try
            '.STCRUK = roundnum(.STCRUM / .RENDIMENT, 2)
            '.STCRUM = roundnum(.STCRUK * .RENDIMENT, 2)
            'Hay que sumar al color del tejido que tiene esta disposicion los kg de la linea
            Dim rendimientoTejido As Double = DLookUp("RENDIMENT", "TEIXITS", " CODI = """ & PAF.lineasCompra.ARTICLE & """ ")
            If rendimientoTejido = 0 Then : REND = 1
            Else : REND = rendimientoTejido : End If
            'Aquí disponemos del rendimiento del tejido

            Select Case PAF.lineasCompra.KM
                Case "K"
                    'Esta representado en kilos
                    METROS = roundnum(cantidad * REND, 2)
                    KILOS = cantidad
                Case "M"
                    METROS = cantidad
                    KILOS = roundnum(cantidad / REND, 2)
                    'Esta representado en metros
            End Select


            cmd = New MySqlCommand("UPDATE TEIXITS " & _
                        " SET STCRUK = STCRUK " & MASMENOS & """" & NS(KILOS, True) & """, " & _
                        " STCRUM = STCRUM " & MASMENOS & """" & NS(METROS, True) & """ " & _
                        " WHERE CODI = """ & PAF.lineasCompra.ARTICLE & """ ", cnn)

            ACN()
            cmd.ExecuteNonQuery()
            CCN()

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try

    End Function
    Private Function ActualizarStockTejidos(ByVal cantidad As Double) As Boolean
        Dim strSQL As String
        Dim stock As Double
        Dim cmdSel As New MySqlCommand
        Dim cmdUpd As New MySqlCommand
        Try
            cmdSel.Connection = cnn
            cmdUpd.Connection = cnn

            ACN()
            If Not cantidad < 0 Then
                If PAF.lineasCompra.COLOR = "**CRU**" AndAlso PAF.TIPUS = Tejido Then
                    SumarQuitarDispuesto("-", cantidad)
                Else
                    strSQL = "UPDATE " & tablaHiloColores & " SET ACTUAL = ACTUAL + " & NS(cantidad, True) & " WHERE(FIL = """ & NS(PAF.lineasCompra.ARTICLE) & """ AND TIPUS = ""T"" AND COLOR = """ & NS(PAF.lineasCompra.COLOR) & """)"
                End If

                cmdUpd.CommandText = strSQL
                cmdUpd.ExecuteNonQuery()
                CCN()
                Return True
            Else
                If PAF.lineasCompra.COLOR = "**CRU**" AndAlso PAF.TIPUS = Tejido Then
                    SumarQuitarDispuesto("+", cantidad)
                Else
                    strSQL = "SELECT ACTUAL FROM " & tablaHiloColores & " WHERE(FIL = """ & NS(PAF.lineasCompra.ARTICLE) & """ AND TIPUS = ""T"" AND COLOR = """ & NS(PAF.lineasCompra.COLOR) & """)"
                    cmdSel.CommandText = strSQL
                    stock = cmdSel.ExecuteScalar() - Math.Abs(cantidad)
                    If stock < 0 Then
                        MessageBox.Show("No hi suficient stock d'aquest teixit es necesiten: " & Math.Abs(stock))
                        If MessageBox.Show(rm.GetString("CONTINUARIGUALMENTE"), "", MessageBoxButtons.YesNo) = DialogResult.Yes Then
                            strSQL = "UPDATE " & tablaHiloColores & " SET ACTUAL = ACTUAL + " & NS(cantidad, True) & " WHERE(FIL = """ & NS(PAF.lineasCompra.ARTICLE) & """ AND TIPUS = ""T"" AND COLOR = """ & NS(PAF.lineasCompra.COLOR) & """)"
                        Else
                            CCN()
                            TRASPASADA = False
                            Return False
                        End If
                    Else
                        strSQL = "UPDATE " & tablaHiloColores & " SET ACTUAL = ACTUAL + " & NS(cantidad, True) & " WHERE(FIL = """ & NS(PAF.lineasCompra.ARTICLE) & """ AND TIPUS = ""T"" AND COLOR = """ & NS(PAF.lineasCompra.COLOR) & """)"
                    End If

                End If
                cmdUpd.CommandText = strSQL
                cmdUpd.ExecuteNonQuery()
                CCN()
                Return True
            End If

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function
    Friend Sub HacerCalculos()
        Dim b As Boolean = True
        Try
            guardarDV()

            If TRASPASADA = True Then
                Select Case PAF.lineasCompra.TIPUS
                    Case Tejido
                        b = ActualizarStockTejidos(-QUANTITAT)
                    Case Muestra
                        'En este caso no hay controles de stock porque estamos en muestras
                        'b = ActualizarStockTejidos(-QUANTITAT)
                End Select
                'En este caso se quiere hacer el traspaso
                If b Then HacerTraspasoLinea()
            Else
                'En este caso se quiere quitar el traspaso
                Select Case PAF.lineasCompra.TIPUS
                    Case Tejido
                        ActualizarStockTejidos(QUANTITAT)
                    Case Muestra
                        'ActualizarStockTejidos(QUANTITAT)
                End Select
            End If
            CantidadTraspasada()

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub

#End Region

#Region "OVERRIDES"

    Friend Overrides Function GenOrder() As String

    End Function
    Friend Overrides Function genWhere() As String

    End Function
    Friend Overrides Function genWhereNumeroRegistros() As String

    End Function
    Friend Overrides Function ObtenerNumeroRegistro(ByVal id As Object) As Integer

    End Function
    Friend Overrides Function TieneCambios() As Boolean
        Try
            guardarDV()
            If Not tabla.GetChanges Is Nothing Then
                Return True
            Else
                Return False
            End If

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function

#End Region

End Class