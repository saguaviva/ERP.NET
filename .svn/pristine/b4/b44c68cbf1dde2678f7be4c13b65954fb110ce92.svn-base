Imports CoreLab.mysql


Public Class clsProcesosOrden
    Inherits clsADO

#Region "CAMPOS"

    Private mORDRE As Double
    Public Property ORDRE() As Double
        Get
            If PA = -1 Then Exit Property
            Try
                mORDRE = nzn(dvForm(pa).Row("ORDRE"), 0)
            Catch ex As Exception : End Try
            Return nzn(mORDRE, 0)
        End Get
        Set(ByVal Value As Double)
            If PA() = -1 Then Exit Property
            mORDRE = nzn(Value, 0)
            dvForm(PA).Row("ORDRE") = nzn(Value, 0) : guardarDV()
        End Set
    End Property

    Private mFET As String
    Public Property FET() As String
        Get
            If PA = -1 Then Exit Property
            Try
                mFET = nz(dvForm(pa).Row("FET"), "")
            Catch ex As Exception : End Try
            Return nz(mFET, "")
        End Get
        Set(ByVal Value As String)
            If PA = -1 Then Exit Property
            mFET = nz(Value, "")
            dvForm(pa).Row("FET") = nz(Value, "") : guardarDV()
        End Set
    End Property

    Private mLINEA As Integer
    Public Property LINEA() As Integer
        Get
            If PA = -1 Then Exit Property
            Try
                mLINEA = nzn(dvForm(pa).Row("LINEA"), 0)
            Catch ex As Exception : End Try
            Return nzn(mLINEA, 0)
        End Get
        Set(ByVal Value As Integer)
            If PA = -1 Then Exit Property
            mLINEA = nzn(Value, 0)
            dvForm(pa).Row("LINEA") = nzn(Value, 0) : guardarDV()
        End Set
    End Property

    Private mCODI As Integer
    Public Property CODI() As Integer
        Get
            If PA() = -1 Then Exit Property
            Try
                mCODI = nzn(dvForm(PA).Row("CODI"), 0)
            Catch ex As Exception : End Try
            Return nzn(mCODI, 0)
        End Get
        Set(ByVal Value As Integer)
            If PA() = -1 Then Exit Property
            If esCodigoExistente(dtOperaciones, "CODI", Value) Then
                If nzn(Value, 0) <> 0 Then
                    mCODI = nzn(Value, 0)
                    dvForm(PA).Row("DESCRI") = OBN(Value, dtOperaciones, "DESCRI")
                    dvForm(PA).Row("CODI") = nzn(Value, 0) : guardarDV()
                End If
            Else
                dvForm(PA).Row("CODI") = 0

                dvForm(PA).Row("DESCRI") = "" : guardarDV()
                MessageBox.Show(rm.GetString("NOEXISTECODIS"))
            End If
        End Set
    End Property

    Private mTALLER As Integer
    Public Property TALLER() As Integer
        Get
            If PA() = -1 Then Exit Property
            Try
                mTALLER = nzn(dvForm(PA).Row("TALLER"), 0)
            Catch ex As Exception : End Try
            Return nzn(mTALLER, 0)
        End Get
        Set(ByVal Value As Integer)
            If PA() = -1 Then Exit Property
            If esCodigoExistente(dtTallers, CCTallers, Value) Then
                If nzn(Value, 0) <> 0 Then
                    mTALLER = nzn(Value, 0)
                    dvForm(PA).Row("NOMTALLER") = OBN(Value, dtTallers, CNTallers)
                    dvForm(PA).Row("TALLER") = nzn(Value, 0) : guardarDV()
                End If
            Else
                dvForm(PA).Row("TALLER") = 0

                dvForm(PA).Row("NOMTALLER") = "" : guardarDV()
                MessageBox.Show(rm.GetString("NOEXISTETALLERS"))
            End If
        End Set
    End Property


    Private mNOMTALLER As String
    Public Property NOMTALLER() As String
        Get
            If PA() = -1 Then Exit Property
            Try
                mNOMTALLER = nz(dvForm(PA).Row("NOMTALLER"), "")
            Catch ex As Exception : End Try
            Return nz(mNOMTALLER, "")
        End Get
        Set(ByVal Value As String)
            If PA() = -1 Then Exit Property
            mNOMTALLER = nz(Value, "")
            If tabla.GetChanges Is Nothing Then
                dvForm(PA).Row("NOMTALLER") = nz(Value, "") : guardarDV()
                tabla.AcceptChanges()
            Else
                dvForm(PA).Row("NOMTALLER") = nz(Value, "") : guardarDV()
            End If
        End Set
    End Property

    Private mSORTIDA As Date
    Public Property SORTIDA() As Date
        Get
            If PA() = -1 Then Exit Property
            Try
                mSORTIDA = dvForm(PA).Row("SORTIDA")
            Catch ex As Exception : End Try
            Return mSORTIDA
        End Get
        Set(ByVal Value As Date)
            If PA() = -1 Then Exit Property
            mSORTIDA = Value
            dvForm(PA).Row("SORTIDA") = Value : guardarDV()
        End Set
    End Property

    Private mPREVISTA As Date
    Public Property PREVISTA() As Date
        Get
            If PA() = -1 Then Exit Property
            Try
                mPREVISTA = dvForm(PA).Row("PREVISTA")
            Catch ex As Exception : End Try
            Return mPREVISTA
        End Get
        Set(ByVal Value As Date)
            If PA() = -1 Then Exit Property
            mPREVISTA = Value
            dvForm(PA).Row("PREVISTA") = Value : guardarDV()
        End Set
    End Property

    Private mFINAL As Date
    Public Property FINAL() As Date
        Get
            If PA() = -1 Then Exit Property
            Try
                mFINAL = dvForm(PA).Row("FINAL")
            Catch ex As Exception : End Try
            Return mFINAL
        End Get
        Set(ByVal Value As Date)
            If PA() = -1 Then Exit Property
            mFINAL = Value
            dvForm(PA).Row("FINAL") = Value : guardarDV()
        End Set
    End Property

#End Region

#Region "VARIABLES"

    Private orden As clsOrdenModelo
    Friend dtTallers As DataTable
    Friend dtOperaciones As DataTable

#End Region

    Public Sub New(ByVal tabla As DataTable, _
                      ByVal centro As String, _
                      ByRef bindingcontext As BindingContext, ByVal ord As clsOrdenModelo)

        MyBase.New(tabla, centro, bindingcontext)
        Dim sqlSel As String
        Try
            orden = ord
            dtTallers = orden.dtTallers.Copy
            dtOperaciones = orden.dtOperaciones.Copy

            sqlSinWhere = "SELECT FEINES.*, " & _
                            " TREBALLS.DESCRI, TALLERS.NOM AS NOMTALLER " & _
                            " FROM FEINES " & _
                            " LEFT JOIN TREBALLS ON (TREBALLS.CODI = FEINES.CODI) " & _
                            " LEFT JOIN TALLERS ON (TALLERS.CODI = FEINES.TALLER) "

            sqlSel = sqlSinWhere & " WHERE FEINES.ORDRE = """ & orden.ORDRE & """ AND FEINES.CENTRO = """ & orden.centro & """ "

            cmdSel.CommandText = sqlSel
            da.SelectCommand = cmdSel
            da.Fill(tabla)
            dvForm.Sort = "LINEA"
            tabla.AcceptChanges()
            PonerDefaults()
            DespertarHandlers()

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    Friend Sub CambioDetalle(ByVal centro As String, ByVal ord As clsOrdenModelo)
        Try
            Dim sqlSel As String
            orden = ord
            Me.centro = centro
            dtTallers = orden.dtTallers.Copy
            dtOperaciones = orden.dtOperaciones.Copy

            sqlSel = sqlSinWhere & " WHERE ORDRE = """ & orden.ORDRE & """ AND FEINES.CENTRO = """ & orden.centro & """ "

            cmdSel.CommandText = sqlSel
            dvForm.Sort = "LINEA"
            da.SelectCommand = cmdSel
            tabla.Clear()
            da.Fill(tabla)
            PonerDefaults()

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    Public Sub DormirHandlers()
        RemoveHandler tabla.RowChanged, AddressOf RowChanged
        RemoveHandler tabla.ColumnChanged, AddressOf CambioColumna
    End Sub
    Public Sub DespertarHandlers()
        AddHandler tabla.RowChanged, AddressOf RowChanged
        AddHandler tabla.ColumnChanged, AddressOf CambioColumna
    End Sub
    Friend Sub RowChanged(ByVal sender As Object, ByVal e As System.data.DataRowChangeEventArgs)
        Try
            DormirHandlers()
            If LINEA = 10000 Then
                Try
                    If dvForm(dvForm.Count - 2).Item("LINEA") = -1 Then
                        LINEA = 1
                    Else
                        LINEA = dvForm(dvForm.Count - 2).Item("LINEA") + 1
                    End If

                Catch ex As Exception
                    LINEA = 1
                End Try
            End If
            DespertarHandlers()

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    Private Sub CambioColumna(ByVal sender As System.Object, ByVal e As System.Data.DataColumnChangeEventArgs)
        Try
            'guardarDV()

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    Private Sub PonerDefaults()
        Try
            With dvForm.Table
                .Columns("ORDRE").DefaultValue = orden.ORDRE
                .Columns("LINEA").DefaultValue = 10000
                .Columns("SORTIDA").DefaultValue = Date.Now.ToShortDateString
                .Columns("PREVISTA").DefaultValue = Date.Now.ToShortDateString
                .Columns("FINAL").DefaultValue = Date.Now.ToShortDateString
                .Columns("CENTRO").DefaultValue = centro
            End With

        Catch ex As Exception
            LOG(ex.ToString)
        End Try
    End Sub

#Region "OVERRIDES"

    Friend Overrides Function TieneCambios() As Boolean
        Try
            guardarDV()
            If Not tabla.GetChanges Is Nothing Then
                Return True
            Else
                Return False
            End If

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function
    Friend Overrides Function genWhere() As String
        Try
            Dim ret As String
            ret = "WHERE " & tabla.TableName & ".CENTRO = """ & centro & """"
            Return ret

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function
    Friend Overrides Function GenOrder() As String
        Try
            Return ""

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function
    Friend Overrides Function ObtenerNumeroRegistro(ByVal id As Object) As Integer
        If id Is Nothing Then
            id = CODI
        End If

        Dim cmd As New MySqlCommand(" SELECT " & _
           " (SELECT COUNT(*) " & _
           " FROM " & tabla.TableName & " AS M2 WHERE " & _
           " M2.CODI < M1.CODI AND  " & WCNoTabla() & " ) AS rownum FROM " & tabla.TableName & " AS M1  WHERE CODI = """ & id & """ AND " & WCNoTabla() & GenOrder(), cnn)
        Try
            Dim idx As Object = cmd.ExecuteScalar()
            If idx Is Nothing Then Return -1
            Return idx '- 1

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function
    Friend Overrides Function genWhereNumeroRegistros() As String
        Try
            Return genWhere()

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function
    Public Overrides Sub borrar()
        Dim i As Integer
        Dim a As New ArrayList
        Dim key(1) As Object
        Try
            For i = 0 To dvForm.Count - 1
                a.Add(dvForm(i).Item("LINEA"))
            Next
            key(0) = ORDRE
            key(2) = centro
            For i = 0 To a.Count - 1
                key(1) = a(i)
                tabla.Rows.Find(key).Delete()
            Next
            ActualizarOrigen(True, True)

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try

    End Sub

#End Region

End Class
