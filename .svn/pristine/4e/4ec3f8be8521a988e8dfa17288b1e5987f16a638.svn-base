Imports CoreLab.MySql
Public Class clsLineasRemesa
    Inherits clsADO

#Region "CAMPOS"

    '+----------+---------------------+------+-----+---------+-------+
    '| Field    | Type                | Null | Key | Default | Extra |
    '+----------+---------------------+------+-----+---------+-------+
    '| REMESA   | int(11)             | NO   | PRI | 0       |       |
    '| REMES    | tinyint(1) unsigned | NO   |     | 0       |       |
    '| VENCIM   | date                | YES  |     | NULL    |       |
    '| IMPORT   | double(15,2)        | YES  |     | NULL    |       |
    '| LINEA    | int(11)             | NO   | PRI | 0       |       |
    '| NEFECTO  | int(11)             | YES  |     | NULL    |       |
    '| CLIENT   | int(11)             | YES  |     | NULL    |       |
    '| CENTRO   | char(1)             | NO   | PRI | C       |       |
    '| DELINEA  | int(11)             | NO   |     | 0       |       |
    '+----------+---------------------+------+-----+---------+-------+
    '8 rows

    Private mREMESA As Integer
    Public Property REMESA() As Integer
        Get
            If PA() = -1 Then Exit Property
            Try
                mREMESA = nzn(dvForm(PA).Row("REMESA"), 0)
            Catch ex As Exception : End Try
            Return nzn(mREMESA, 0)
        End Get
        Set(ByVal Value As Integer)
            If PA() = -1 Then Exit Property
            If nzn(Value, 0) <> nzn(REMESA, 0) Then
                mREMESA = nzn(Value, 0)
                dvForm(PA).Row("IDREMESA") = nzn(mREMESA, 0) : guardarDV()
            End If
        End Set
    End Property

    Private mREMES As Boolean
    Public Property REMES() As Boolean
        Get
            If PA() = -1 Then Exit Property
            Try
                mREMES = dvForm(PA).Row("REMES")
            Catch ex As Exception : End Try
            Return mREMES
        End Get
        Set(ByVal Value As Boolean)
            If PA() = -1 Then Exit Property
            If Value <> REMES Then
                mREMES = Value
                dvForm(PA).Row("REMES") = mREMES : guardarDV()
            End If
        End Set
    End Property

    Private mVENCIM As Date
    Public Property VENCIM() As Date
        Get
            If PA() = -1 Then Exit Property
            Try
                mVENCIM = dvForm(PA).Row("VENCIM")
            Catch ex As Exception : End Try
            Return mVENCIM
        End Get
        Set(ByVal Value As Date)
            If PA() = -1 Then Exit Property
            If Value <> VENCIM Then
                mVENCIM = Value
                dvForm(PA).Row("VENCIM") = mVENCIM : guardarDV()
            End If
        End Set
    End Property

    Private mIMPORT As Double
    Public Property IMPORT() As Double
        Get
            If PA() = -1 Then Exit Property
            Try
                mIMPORT = nzn(dvForm(PA).Row("IMPORT"), 0)
            Catch ex As Exception : End Try
            Return nzn(mIMPORT, 0)
        End Get
        Set(ByVal Value As Double)
            If PA() = -1 Then Exit Property
            If nzn(Value, 0) <> nzn(IMPORT, 0) Then
                mIMPORT = nzn(Value, 0)
                dvForm(PA).Row("IMPORT") = nzn(mIMPORT, 0) : guardarDV()
            End If
        End Set
    End Property

    Private mLINEA As Integer
    Public Property LINEA() As Integer
        Get
            If PA() = -1 Then Exit Property
            Try
                mLINEA = nzn(dvForm(PA).Row("LINEA"), 0)
            Catch ex As Exception : End Try
            Return nzn(mLINEA, 0)
        End Get
        Set(ByVal Value As Integer)
            If PA() = -1 Then Exit Property
            If nzn(Value, 0) <> nzn(LINEA, 0) Then
                mLINEA = nzn(Value, 0)
                dvForm(PA).Row("LINEA") = nzn(mLINEA, 0) : guardarDV()
            End If
        End Set
    End Property

    Private mDELINEA As Integer
    Public Property DELINEA() As Integer
        Get
            If PA() = -1 Then Exit Property
            Try
                mDELINEA = nzn(dvForm(PA).Row("DELINEA"), 0)
            Catch ex As Exception : End Try
            Return nzn(mDELINEA, 0)
        End Get
        Set(ByVal Value As Integer)
            If PA() = -1 Then Exit Property
            If nzn(Value, 0) <> nzn(DELINEA, 0) Then
                mDELINEA = nzn(Value, 0)
                dvForm(PA).Row("DELINEA") = nzn(mDELINEA, 0) : guardarDV()
            End If
        End Set
    End Property

    Private mNEFECTO As Integer
    Public Property NEFECTO() As Integer
        Get
            If PA() = -1 Then Exit Property
            Try
                mNEFECTO = nzn(dvForm(PA).Row("NEFECTO"), 0)
            Catch ex As Exception : End Try
            Return nzn(mNEFECTO, 0)
        End Get
        Set(ByVal Value As Integer)
            If PA() = -1 Then Exit Property
            If nzn(Value, 0) <> nzn(NEFECTO, 0) Then
                mNEFECTO = nzn(Value, 0)
                dvForm(PA).Row("NEFECTO") = nzn(mNEFECTO, 0) : guardarDV()
            End If
        End Set
    End Property

    Private mCLIENT As Integer
    Public Property CLIENT() As Integer
        Get
            If PA() = -1 Then Exit Property
            Try
                mCLIENT = nzn(dvForm(PA).Row("CLIENT"), 0)
            Catch ex As Exception : End Try
            Return nzn(mCLIENT, 0)
        End Get
        Set(ByVal Value As Integer)
            If PA() = -1 Then Exit Property
            If esCodigoExistente(dtClients, CCClients, Value) Then
                If nzn(Value, 0) <> 0 Then
                    mCLIENT = nzn(Value, 0)
                    dvForm(PA).Row("NOMCLIENT") = OBN(Value, dtClients, CNClients)
                    dvForm(PA).Row("CLIENT") = nzn(Value, 0) : guardarDV()
                Else
                    dvForm(PA).Row("CLIENT") = DBNull.Value

                    dvForm(PA).Row("NOMCLIENT") = "" : guardarDV()
                End If
            Else
                dvForm(PA).Row("CLIENT") = DBNull.Value

                dvForm(PA).Row("NOMCLIENT") = "" : guardarDV()
                MessageBox.Show(rm.GetString("NOEXISTECLIENTS"))
            End If
        End Set
    End Property

    Private mNOMCLIENT As String
    Public Property NOMCLIENT() As String
        Get
            If PA() = -1 Then Exit Property
            Try
                mNOMCLIENT = nz(dvForm(PA).Row("NOMCLIENT"), "")
            Catch ex As Exception : End Try
            Return nz(mNOMCLIENT, "")
        End Get
        Set(ByVal Value As String)
            If PA() = -1 Then Exit Property
            mNOMCLIENT = nz(Value, "")
            If tabla.GetChanges Is Nothing Then
                dvForm(PA).Row("NOMCLIENT") = nz(Value, "") : guardarDV()
                tabla.AcceptChanges()
            Else
                dvForm(PA).Row("NOMCLIENT") = nz(Value, "") : guardarDV()
            End If
        End Set
    End Property

#End Region

#Region "VARIABLES"

    Private remesaa As clsRemesa
    Public dtClients As New DataTable

#End Region

#Region "INICIARLIZAR"

    Public Sub New(ByVal tabla As DataTable, _
                    ByVal centro As String, ByRef bindingcontext As BindingContext, ByVal reme As clsRemesa)
        MyBase.New(tabla, centro, bindingcontext, "ESDETALLE")
        Dim sqlSel As String
        Try
            remesaa = reme
            Me.centro = remesaa.centro
            sqlSinWhere = "SELECT dremesas.*, " & _
                    " clients.POB AS PLAZA, clients.NOM AS NOMCLIENT FROM dremesas " & _
                    " LEFT JOIN clients ON (clients.CODI = dremesas.CLIENT) "

            sqlSel = sqlSinWhere & " WHERE REMESA = " & remesaa.CODI & " AND DREMESAS.CENTRO = """ & remesaa.centro & """ "
            DormirHandlers()

            cmdSel.CommandText = sqlSel
            da.SelectCommand = cmdSel
            da.Fill(tabla)
            'CreaTablas()
            'PonerDefaults()
            dvForm.Sort = "LINEA ASC"
            DespertarHandlers()
            'dvIdentificadores.RowFilter = "CENTRO = '" & centro & "' "

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    Friend Sub DespertarHandlers()

        Try : AddHandler tabla.RowChanged, AddressOf RowChanged : Catch : End Try

    End Sub
    Friend Sub DormirHandlers()

        Try : RemoveHandler tabla.RowChanged, AddressOf RowChanged : Catch : End Try

    End Sub
    Friend Sub CambioDetalle(ByVal centro As String, ByVal reme As clsRemesa)
        Dim sqlSel As String
        Try
            remesaa = reme
            Me.centro = remesaa.centro
            sqlSel = sqlSinWhere & " WHERE REMESA = " & remesaa.CODI & ""

            cmdSel.CommandText = sqlSel
            da.SelectCommand = cmdSel
            dvForm.Sort = "LINEA ASC"
            tabla.Clear()
            da.Fill(tabla)
            'dvIdentificadores.RowFilter = "CENTRO = '" & centro & "' "

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    Public Sub ActualizarDetalle()
        Dim i As Integer
        Dim cambio As Boolean = False
        Try
            For i = 0 To dvForm.Count - 1
                If nzn(dvForm(i).Item("REMESA"), "") <> nzn(remesaa.CODI, 0) Then dvForm(i).Item("REMESA") = nzn(remesaa.CODI, 0) : cambio = True
            Next
            If cambio Then guardarDV()

        Catch ex As Exception
            LOG(ex.ToString)
        End Try
    End Sub
    Friend Sub RowChanged(ByVal sender As Object, ByVal e As System.data.DataRowChangeEventArgs)
        Try
            DormirHandlers()
            If LINEA = 10000 Then
                Try
                    If dvForm(dvForm.Count - 2).Item("LINEA") = -1 Then
                        LINEA = 1
                    Else
                        LINEA = dvForm(dvForm.Count - 2).Item("LINEA") + 1
                    End If
                Catch ex As Exception
                    LINEA = 1
                End Try
            End If
            DespertarHandlers()

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    Private Sub PonerDefaults()
        Try
            dvForm.Table.Columns("VENCIM").DefaultValue = Date.Now.ToShortDateString
            dvForm.Table.Columns("IMPORT").DefaultValue = 0
            dvForm.Table.Columns("LINEA").DefaultValue = 100000
            dvForm.Table.Columns("NEFECTO").DefaultValue = 0
            dvForm.Table.Columns("CLIENT").DefaultValue = 0
            dvForm.Table.Columns("NOMCLIENT").DefaultValue = ""
            dvForm.Table.Columns("PLAZA").DefaultValue = ""
            dvForm.Table.Columns("REMES").DefaultValue = False

        Catch ex As Exception
            LOG(ex.ToString)
        End Try
    End Sub

#End Region

    Public Sub borrarLineaActual()
        Try
            Dim c As New MySqlCommand("UPDATE VENCIM SET REMES = FALSE WHERE FRA = " & NEFECTO & " AND LIN = " & DELINEA, cnn)
            ACN()
            c.ExecuteNonQuery()
            remesaa.ActualizarOrigen()
            CCN()

        Catch ex As Exception
            LOG(ex.ToString)
        End Try
    End Sub

#Region "OVERRIDES"
    Friend Overrides Function TieneCambios() As Boolean
        Try
            guardarDV()
            If Not tabla.GetChanges Is Nothing Then
                Return True
            Else
                Return False
            End If

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function
    Public Overrides Sub borrar()
        Try
            BorrarActualDV()
        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    Friend Overrides Function genWhere() As String
        Try
            Dim ret As String

            ret = "WHERE " & tabla.TableName & ".CENTRO = """ & remesaa.centro & """"

            Return ret
        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function
    Friend Overrides Function GenOrder() As String
        Try
            Return ""
            'Return " ORDER BY TEMPORADA, CLIENT, SERIE, CODI "
        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function
    Friend Overrides Function ObtenerNumeroRegistro(ByVal id As Object) As Integer
        If id Is Nothing Then
            id = REMESA
        End If

        Dim cmd As New MySqlCommand(" SELECT " & _
           " (SELECT COUNT(*) " & _
           " FROM " & tabla.TableName & " AS M2 WHERE " & _
           " M2.CODI < M1.CODI AND  " & WCNoTabla() & " ) AS rownum FROM " & tabla.TableName & " AS M1  WHERE CODI = """ & id & """ AND " & WCNoTabla() & GenOrder(), cnn)
        Try
            Dim idx As Object = cmd.ExecuteScalar()
            If idx Is Nothing Then Return -1
            Return idx '- 1

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function
    Friend Overrides Function genWhereNumeroRegistros() As String
        Try
            Return genWhere()
        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function
    Public Overrides Sub ActualizarOrigen(Optional ByVal nocerrar As Boolean = False, Optional ByVal hackDetalle As Boolean = False)
        Try
            ActualizarDetalle()
            MyBase.ActualizarOrigen(True, True)

        Catch ex As Exception
            LOG(ex.ToString)
        End Try
    End Sub

#End Region

End Class