Imports CoreLab.MySql

Public Class clsIVA
    Inherits clsADO

#Region "CAMPOS"

    Private mCODI As String
    Public Property CODI() As String
        Get
            If PA = -1 Then Exit Property
            Try
                mCODI = nz(dvForm(pa).Row("CODI"), "")
            Catch ex As Exception : End Try
            Return nz(mCODI, "")
        End Get
        Set(ByVal Value As String)
            If PA = -1 Then Exit Property
            If nz(Value, "") <> nz(CODI, "") Then
                mCODI = nz(Value, "")
                dvForm(pa).Row("CODI") = nz(mCODI, "") : GuardarDV()
            End If
        End Set
    End Property

    Private mDESCRIPCIO As String
    Public Property DESCRIPCIO() As String
        Get
            If PA = -1 Then Exit Property
            Try
                mDESCRIPCIO = nz(dvForm(pa).Row("DESCRIPCIO"), "")
            Catch ex As Exception : End Try
            Return nz(mDESCRIPCIO, "")
        End Get
        Set(ByVal Value As String)
            If PA = -1 Then Exit Property
            If nz(Value, "") <> nz(DESCRIPCIO, "") Then
                mDESCRIPCIO = nz(Value, "")
                dvForm(pa).Row("DESCRIPCIO") = nz(mDESCRIPCIO, "") : GuardarDV()
            End If
        End Set
    End Property

    Private mIVA As Double
    Public Property IVA() As Double
        Get
            If PA = -1 Then Exit Property
            Try
                mIVA = nzn(dvForm(pa).Row("IVA"), 0)
            Catch ex As Exception : End Try
            Return nzn(mIVA, 0)
        End Get
        Set(ByVal Value As Double)
            If PA = -1 Then Exit Property
            If nzn(Value, 0) <> nzn(IVA, 0) Then
                mIVA = nzn(Value, 0)
                dvForm(pa).Row("IVA") = nzn(mIVA, 0) : GuardarDV()
            End If
        End Set
    End Property

    Private mRE As Double
    Public Property RE() As Double
        Get
            If PA = -1 Then Exit Property
            Try
                mRE = nzn(dvForm(pa).Row("RE"), 0)
            Catch ex As Exception : End Try
            Return nzn(mRE, 0)
        End Get
        Set(ByVal Value As Double)
            If PA = -1 Then Exit Property
            If nzn(Value, 0) <> nzn(RE, 0) Then
                mRE = nzn(Value, 0)
                dvForm(pa).Row("RE") = nzn(mRE, 0) : GuardarDV()
            End If
        End Set
    End Property

#End Region

    Public Sub New(ByVal tabla As DataTable, _
                ByVal centro As String, ByRef bindingcontext As BindingContext)

        MyBase.New(tabla, centro, BindingContext)
        Dim sqlSel As String
        Try

            sqlSinWhere = "SELECT IVA.*, " & _
                     " filiales.DESCRI AS NOMCENTRO " & _
                     " FROM IVA " & _
                     " LEFT JOIN filiales ON (filiales.CODI = IVA.CENTRO) "
            sqlSel = sqlSinWhere & _
                        " WHERE IVA.CENTRO = """ & centro & """ ORDER BY IVA.CODI " & _
                        " LIMIT 1"
            cmdSel.CommandText = sqlSel

            da.SelectCommand = cmdSel
            da.Fill(tabla)
            CargarIdentificadores()


        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : ccn()
        End Try
    End Sub
    Public Overrides Sub CargarIdentificadores()
        Try
            CargaTabla(tablaIVA, CCIVA, CNIVA, dtIdentificadores, True)
            dtIdentificadores.Columns(CCIVA).Caption = rm.GetString("CODIGO")
            dtIdentificadores.Columns(CNIVA).Caption = rm.GetString("NOM")
            dvIdentificadores.RowFilter = "CENTRO = '" & centro & "' "
            dvIdentificadores.Sort = CNIVA

        Catch ex As Exception
            LOG(ex.ToString)
        End Try
    End Sub

#Region "DESPLAZAMIENTO"

    Public Overloads Sub SiguienteReg()
        Try
            MyBase.SiguienteReg()
            'Try : codigoActual = tabla.DefaultView(pa).Item("CODI") : Catch ex As Exception : End Try
        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : ccn()
        End Try
    End Sub
    Public Overloads Sub AnteriorReg()
        Try
            MyBase.AnteriorReg()

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : ccn()
        End Try
    End Sub
    Public Overloads Sub UltimoReg()
        Try
            MyBase.UltimoReg()

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : ccn()
        End Try
    End Sub
    Public Overloads Sub PrimeroReg()
        Try
            MyBase.PrimeroReg()

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : ccn()
        End Try
    End Sub
    Public Overloads Sub CambiarAReg(ByVal id As String, ByVal accion As Integer)
        Try
            MyBase.CambiarAReg(id, "", accion)

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : ccn()
        End Try
    End Sub

#End Region

#Region "OVERRIDES"

    Friend Overrides Function TieneCambios() As Boolean
        Try
            guardarDV()
            If Not tabla.GetChanges Is Nothing Then
                Return True
            Else
                Return False
            End If

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function
    Public Overloads Sub NuevoRegistro()
        Try
            MyBase.NuevoRegistro()

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : ccn()
        End Try
    End Sub
    Friend Overrides Function genWhere() As String
        Try
            Dim ret As String
            ret = "WHERE " & tabla.TableName & ".CENTRO = """ & centro & """"
            Return ret

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : ccn()
        End Try
    End Function
    Friend Overrides Function GenOrder() As String
        Try
            Return " ORDER BY CODI "
            'Return " ORDER BY TEMPORADA, CLIENT, SERIE, CODI "

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : ccn()
        End Try
    End Function
    Friend Overrides Function ObtenerNumeroRegistro(ByVal id As Object) As Integer
        If id Is Nothing Then
            id = CODI
        End If

        Dim cmd As New MySqlCommand(" SELECT " & _
            " (SELECT COUNT(*) " & _
            " FROM " & tabla.TableName & " AS M2 WHERE " & _
            " M2.CODI < M1.CODI AND  " & WCNoTabla() & " ) AS rownum FROM " & tabla.TableName & " AS M1  WHERE CODI = """ & id & """ AND " & WCNoTabla() & GenOrder(), cnn)
        Try
            Dim idx As Object = cmd.ExecuteScalar()
            If idx Is Nothing Then Return -1
            Return idx '- 1

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : ccn()
        End Try
    End Function
    Friend Overrides Function genWhereNumeroRegistros() As String
        Try
            Return genWhere()

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : ccn()
        End Try
    End Function

#End Region

End Class
