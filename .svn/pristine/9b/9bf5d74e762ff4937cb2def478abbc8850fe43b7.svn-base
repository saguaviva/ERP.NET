Imports CoreLab.MySql
Public Class clsCartaColoresTejido
    Inherits clsADO

#Region "VARIABLES"

    Friend m_Tejido As clsTejido
    Friend dtProve As New DataTable("PROVE")

#End Region

#Region "CAMPOS"

    Private mTIPUS As String
    Public Property TIPUS() As String
        Get
            If PA = -1 Then Exit Property
            Try
                mTIPUS = nz(dvForm(pa).Row("TIPUS"), "")
            Catch ex As Exception : End Try
            Return nz(mTIPUS, "")
        End Get
        Set(ByVal Value As String)
            If PA = -1 Then Exit Property
            If nz(Value, "") <> nz(TIPUS, "") Then
                mTIPUS = nz(Value, "")
                dvForm(pa).Row("TIPUS") = nz(mTIPUS, "") : guardarDV()
            End If
        End Set
    End Property

    Private mFIL As String
    Public Property FIL() As String
        Get
            If PA = -1 Then Exit Property
            Try
                mFIL = nz(dvForm(pa).Row("FIL"), "")
            Catch ex As Exception : End Try
            Return nz(mFIL, "")
        End Get
        Set(ByVal Value As String)
            If PA = -1 Then Exit Property
            If nz(Value, "") <> nz(FIL, "") Then
                mFIL = nz(Value, "")
                dvForm(pa).Row("FIL") = nz(mFIL, "") : guardarDV()
            End If
        End Set
    End Property

    Private mPROVE As Integer
    Public Property PROVE() As Integer
        Get
            If PA = -1 Then Exit Property
            Try
                mPROVE = nzn(dvForm(pa).Row(tablaProveedores), 0)
            Catch ex As Exception : End Try
            Return nzn(mPROVE, 0)
        End Get
        Set(ByVal Value As Integer)
            If PA = -1 Then Exit Property
            If esCodigoExistente(dtProve, CCProve, Value) Then
                If nzn(Value, 0) <> 0 Then
                    mPROVE = nzn(Value, 0)
                    dvForm(pa).Row("NOMPROVE") = OBN(Value, dtProve, CNProve)
                    dvForm(pa).Row(tablaProveedores) = nzn(Value, 0) : guardarDV()
                End If
            Else
                dvForm(pa).Row("PROVE") = 0

                dvForm(pa).Row("NOMPROVE") = "" : guardarDV()
                MessageBox.Show(rm.GetString("NOEXISTEPROVE"))
            End If
        End Set
    End Property

    Private mNOMPROVE As String
    Public Property NOMPROVE() As String
        Get
            If PA = -1 Then Exit Property
            Try
                mNOMPROVE = nz(dvForm(pa).Row("NOMPROVE"), "")
            Catch ex As Exception : End Try
            Return nz(mNOMPROVE, "")
        End Get
        Set(ByVal Value As String)
            If PA = -1 Then Exit Property
            mNOMPROVE = nz(Value, "")
            If tabla.GetChanges Is Nothing Then
                dvForm(pa).Row("NOMPROVE") = nz(Value, "") : guardarDV()
                tabla.AcceptChanges()
            Else
                dvForm(pa).Row("NOMPROVE") = nz(Value, "") : guardarDV()
            End If
        End Set
    End Property

    Private mCOLOR As String
    Public Property COLOR() As String
        Get
            If PA = -1 Then Exit Property
            Try
                mCOLOR = nz(dvForm(pa).Row("COLOR"), "")
            Catch ex As Exception : End Try
            Return nz(mCOLOR, "")
        End Get
        Set(ByVal Value As String)
            If PA = -1 Then Exit Property
            If nz(Value, "") <> nz(COLOR, "") Then
                mCOLOR = nz(Value, "")
                dvForm(pa).Row("COLOR") = nz(mCOLOR, "") : guardarDV()
            End If
        End Set
    End Property

    Private mACTUAL As Double
    Public Property ACTUAL() As Double
        Get
            If PA = -1 Then Exit Property
            Try
                mACTUAL = nzn(dvForm(pa).Row("ACTUAL"), 0)
            Catch ex As Exception : End Try
            Return nzn(mACTUAL, 0)
        End Get
        Set(ByVal Value As Double)
            If PA = -1 Then Exit Property
            If nzn(Value, 0) <> nzn(ACTUAL, 0) Then
                mACTUAL = nzn(Value, 0)
                dvForm(pa).Row("ACTUAL") = nzn(mACTUAL, 0) : guardarDV()
            End If
        End Set
    End Property

    Private mMINIM As Double
    Public Property MINIM() As Double
        Get
            If PA = -1 Then Exit Property
            Try
                mMINIM = nzn(dvForm(pa).Row("MINIM"), 0)
            Catch ex As Exception : End Try
            Return nzn(mMINIM, 0)
        End Get
        Set(ByVal Value As Double)
            If PA = -1 Then Exit Property
            If nzn(Value, 0) <> nzn(MINIM, 0) Then
                mMINIM = nzn(Value, 0)
                dvForm(pa).Row("MINIM") = nzn(mMINIM, 0) : guardarDV()
            End If
        End Set
    End Property

    Private mPREU As Double
    Public Property PREU() As Double
        Get
            If PA = -1 Then Exit Property
            Try
                mPREU = nzn(dvForm(pa).Row("PREU"), 0)
            Catch ex As Exception : End Try
            Return nzn(mPREU, 0)
        End Get
        Set(ByVal Value As Double)
            If PA = -1 Then Exit Property
            If nzn(Value, 0) <> nzn(PREU, 0) Then
                mPREU = nzn(Value, 0)
                dvForm(pa).Row("PREU") = nzn(mPREU, 0) : guardarDV()
            End If
        End Set
    End Property

    Private mTINTAR As Double
    Public Property TINTAR() As Double
        Get
            If PA = -1 Then Exit Property
            Try
                mTINTAR = nzn(dvForm(pa).Row("TINTAR"), 0)
            Catch ex As Exception : End Try
            Return nzn(mTINTAR, 0)
        End Get
        Set(ByVal Value As Double)
            If PA = -1 Then Exit Property
            If nzn(Value, 0) <> nzn(TINTAR, 0) Then
                mTINTAR = nzn(Value, 0)
                dvForm(pa).Row("TINTAR") = nzn(mTINTAR, 0) : guardarDV()
            End If
        End Set
    End Property

    Private mMETRES As Double
    Public Property METRES() As Double
        Get
            If PA = -1 Then Exit Property
            Try
                mMETRES = nzn(dvForm(pa).Row("METRES"), 0)
            Catch ex As Exception : End Try
            Return nzn(mMETRES, 0)
        End Get
        Set(ByVal Value As Double)
            If PA = -1 Then Exit Property
            If nzn(Value, 0) <> nzn(METRES, 0) Then
                mMETRES = nzn(Value, 0)
                dvForm(pa).Row("METRES") = nzn(mMETRES, 0) : guardarDV()
            End If
        End Set
    End Property

    Private mKG As Double
    Public Property KG() As Double
        Get
            If PA = -1 Then Exit Property
            Try
                mKG = nzn(dvForm(pa).Row("KG"), 0)
            Catch ex As Exception : End Try
            Return nzn(mKG, 0)
        End Get
        Set(ByVal Value As Double)
            If PA = -1 Then Exit Property
            If nzn(Value, 0) <> nzn(KG, 0) Then
                mKG = nzn(Value, 0)
                dvForm(pa).Row("KG") = nzn(mKG, 0) : guardarDV()
            End If
        End Set
    End Property

    Private mOBSERV As String
    Public Property OBSERV() As String
        Get
            If PA = -1 Then Exit Property
            Try
                mOBSERV = nz(dvForm(pa).Row("OBSERV"), "")
            Catch ex As Exception : End Try
            Return nz(mOBSERV, "")
        End Get
        Set(ByVal Value As String)
            If PA = -1 Then Exit Property
            If nz(Value, "") <> nz(OBSERV, "") Then
                mOBSERV = nz(Value, "")
                dvForm(pa).Row("OBSERV") = nz(mOBSERV, "") : guardarDV()
            End If
        End Set
    End Property

#End Region

    Public Sub New(ByVal tabla As DataTable, _
                ByVal centro As String, ByRef bindingcontext As BindingContext, ByVal tejid As clsTejido)

        MyBase.New(tabla, centro, bindingcontext, "ESDETALLE")
        Dim sqlSel As String
        Try
            m_Tejido = tejid

            sqlSinWhere = "SELECT filcol.*, " & _
                            " filiales.DESCRI AS NOMCENTRO " & _
                            " FROM filcol " & _
                            " LEFT JOIN filiales ON (filiales.CODI = filcol.CENTRO) "

            sqlSel = sqlSinWhere & _
                        " WHERE filcol.TIPUS = ""T"" AND " & _
                        " filcol.PROVE = 0 AND " & _
                        " filcol.FIL = """ & m_Tejido.CODI & """ AND " & _
                        " filcol.CENTRO = """ & m_Tejido.centro & """ " & _
                        " ORDER BY filcol.color"

            '" LIMIT 1"
            cmdSel.CommandText = sqlSel
            dvForm.Sort = "COLOR"
            da.SelectCommand = cmdSel
            da.Fill(tabla)

            PonerDefaults()
            tabla.AcceptChanges()
            AddHandler tabla.ColumnChanged, AddressOf CanviarColumnaColores
        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : ccn()
        End Try
    End Sub

#Region "ORGANIZAR"

    Private Sub CanviarColumnaColores(ByVal sender As Object, ByVal e As System.Data.DataColumnChangeEventArgs)
        Dim TantoPorciento As Double = 0
        Dim sumaTantosPorcientos As Double = 0
        Dim Importe As Double = 0
        Dim Precio As Double = 0
        Dim precioMetros As Double = 0
        Dim precioKG As Double = 0
        Dim coste As Double = 0

        Try
            DormirHandlers()
            'If Not e.Row.RowState = DataRowState.Unchanged And Not e.Row.RowState = DataRowState.Detached Then
            guardarDV()
            'End If

            If Not tabla.GetChanges Is Nothing Then
                coste = m_Tejido.CRU + TINTAR
                precioKG = coste / (1 - m_Tejido.MARGE / 100)
                precioMetros = precioKG / IIf(m_Tejido.RENDIMENT = 0, 1, m_Tejido.RENDIMENT)

                PREU = roundnum(coste, 2)
                KG = roundnum(precioKG, 2)
                METRES = roundnum(precioMetros, 2)

            End If
            DespertarHandlers()

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : ccn()
        End Try
    End Sub
    Public Sub DormirHandlers()
        Try
            RemoveHandler tabla.ColumnChanged, AddressOf CanviarColumnaColores

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    Public Sub DespertarHandlers()
        Try
            AddHandler tabla.ColumnChanged, AddressOf CanviarColumnaColores
        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    Private Sub PonerDefaults()

        Try
            With dvForm
                .Table.Columns("TIPUS").DefaultValue = "T"
                .Table.Columns("MEDIDA").DefaultValue = ""
                .Table.Columns("FIL").DefaultValue = m_Tejido.CODI
                .Table.Columns("PROVE").DefaultValue = 0
                .Table.Columns("OBSERV").DefaultValue = ""
                .Table.Columns("COLOR").DefaultValue = ""
                .Table.Columns("ACTUAL").DefaultValue = 0
                .Table.Columns("MINIM").DefaultValue = 0
                .Table.Columns("TINTAR").DefaultValue = 0
                .Table.Columns("PREU").DefaultValue = 0
                .Table.Columns("METRES").DefaultValue = 0
                .Table.Columns("KG").DefaultValue = 0
                .Table.Columns("CENTRO").DefaultValue = m_Tejido.centro
            End With

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    Friend Sub CambioDetalle(ByVal centro As String, ByVal tejid As clsTejido)
        Dim sqlSel As String
        Try
            m_Tejido = tejid
            Me.centro = centro
            sqlSinWhere = "SELECT filcol.*, " & _
                            " filiales.DESCRI AS NOMCENTRO " & _
                            " FROM filcol " & _
                            " LEFT JOIN filiales ON (filiales.CODI = filcol.CENTRO) "

            sqlSel = sqlSinWhere & _
                        " WHERE filcol.TIPUS = ""T"" AND " & _
                        " filcol.PROVE = 0 AND " & _
                        " filcol.FIL = """ & m_Tejido.CODI & """ AND " & _
                        " filcol.CENTRO = """ & m_Tejido.centro & """ " & _
                        " ORDER BY filcol.color"

            cmdSel.CommandText = sqlSel
            dvForm.Sort = "COLOR"
            da.SelectCommand = cmdSel
            tabla.Clear()
            da.Fill(tabla)

            PonerDefaults()
            tabla.AcceptChanges()
        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    Public Sub ActualizarDetalle()
        Dim i As Integer
        Dim cambio As Boolean = False
        Try
            For i = 0 To dvForm.Count - 1
                If nz(dvForm(i).Item("FIL"), "") <> nz(m_Tejido.CODI, "") Then dvForm(i).Item("FIL") = nz(m_Tejido.CODI, "") : cambio = True
            Next
            If cambio Then guardarDV()

        Catch ex As Exception
            LOG(ex.ToString)
        End Try
    End Sub
    Public Overrides Sub ActualizarOrigen(Optional ByVal nocerrar As Boolean = False, Optional ByVal hackDetalle As Boolean = False)
        Try
            ActualizarDetalle()
            MyBase.ActualizarOrigen(True, True)

        Catch ex As Exception
            LOG(ex.ToString)
        End Try
    End Sub
    Public Overrides Sub borrar()
        BorrarActualDVDetalle()
        'ActualizarOrigen()
    End Sub

#End Region

#Region "OVERRIDES"

    Friend Overrides Function TieneCambios() As Boolean
        Try
            guardarDV()
            If Not tabla.GetChanges Is Nothing Then
                Return True
            Else
                Return False
            End If

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function
    Friend Overrides Function genWhere() As String
        Try
            Dim ret As String

            ret = "WHERE " & tabla.TableName & ".CENTRO = """ & centro & """"

            Return ret
        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function
    Friend Overrides Function GenOrder() As String
        Try
            Return " ORDER BY filcol.color "
            'Return " ORDER BY TEMPORADA, CLIENT, SERIE, CODI "
        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function
    Friend Overrides Function ObtenerNumeroRegistro(ByVal id As Object) As Integer
        If id Is Nothing Then
            id = FIL
        End If

        Dim cmd As New MySqlCommand(" SELECT " & _
           " (SELECT COUNT(*) " & _
           " FROM " & tabla.TableName & " AS M2 WHERE " & _
           " M2.CODI < M1.CODI AND  " & WCNoTabla() & " ) AS rownum FROM " & tabla.TableName & " AS M1  WHERE CODI = """ & id & """ AND " & WCNoTabla() & GenOrder(), cnn)
        Try
            Dim idx As Object = cmd.ExecuteScalar()

            If idx Is Nothing Then Return -1
            Return idx '- 1

        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function
    Friend Overrides Function genWhereNumeroRegistros() As String
        Try
            Return genWhere()
        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Function

#End Region

    Public Sub AñadirColor(ByVal color As String)
        Dim dr As DataRow
        Try
            dr = tabla.NewRow
            dr("COLOR") = color
            dr.Item("PREU") = m_Tejido.CRU + dr.Item("TINTAR")
            dr.Item("KG") = dr.Item("PREU") / (1 - m_Tejido.MARGE / 100)
            dr.Item("METRES") = dr.Item("KG") / IIf(m_Tejido.RENDIMENT = 0, 1, m_Tejido.RENDIMENT)
            dr.Item("CENTRO") = m_Tejido.centro

            Try
                tabla.Rows.Add(dr)
                MyBase.ActualizarOrigen(True, True)
            Catch ex As Exception
                'Throw ex
                LOG(ex.ToString, True)
            End Try


        Catch ex As Exception
            LOG(ex.ToString) : cargando = False : CCN()
        End Try
    End Sub
    

End Class
